<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holzrechner Dashboard (Netto/Brutto nur in PDF)</title>
    <!-- Einbindung von Tailwind CSS für Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Einbindung der jspdf-Bibliotheken für PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Setzt die Standard-Schriftart auf Inter und sorgt für eine fließende Höhe */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Definiert eine schmale Schriftart für die Tabelle, falls auf mobilen Geräten benötigt */
        .table-font {
            font-size: 0.8rem;
        }
        /* Stellt sicher, dass das Modal über allem liegt */
        .modal-overlay {
            z-index: 50; 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Navigationsleiste -->
    <nav class="bg-white shadow-xl p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center max-w-7xl">
            <!-- Logo oder Markenname -->
            <a href="index.html" class="text-2xl font-extrabold text-blue-600">Sägewerk Mülleder</a>
            <!-- Navigationslinks mit ARCHIV -->
            <div class="flex space-x-6">
                <a href="index.html" class="text-blue-600 font-bold hover:text-blue-800 transition duration-300 border-b-3 border-blue-600 pb-1">Dashboard</a>
                <a href="archiv.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Archiv</a>
                <a href="kunden.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Kunden</a>
                <a href="preise.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Preise</a>
            </div>
        </div>
    </nav>

    <!-- Hauptinhalt (Dashboard Ansicht) -->
    <main class="flex-grow container mx-auto p-4 sm:p-8 max-w-7xl">
        <div class="w-full mx-auto">
            <!-- HAUPTTITEL FÜR DIE SEITE -->
            <h1 class="text-4xl font-extrabold text-green-700 mb-8 text-center sm:text-left">
                Holzrechner Sägewerk Mülleder
            </h1>

            <!-- SEKTION: Holzrechner -->
            <div class="bg-white p-6 sm:p-10 shadow-2xl rounded-xl w-full mb-10 border-t-6 border-blue-600">
                
                <!-- ÜBERSCHRIFT -->
                <h2 class="text-3xl font-bold text-blue-700 mb-8">Holzrechner</h2>
                
                <!-- Geänderte Grid-Struktur für 6 Spalten auf MD+ (5 Eingaben + 1 Ausgabe, jetzt 2 Ausgaben) -->
                <form id="wood-entry-form" class="grid grid-cols-2 md:grid-cols-7 gap-6 items-end">
                    
                    <!-- Verstecktes Feld zur Speicherung der ID bei Bearbeitung -->
                    <input type="hidden" id="editing-id" value="">
                    
                    <!-- Feld: Kunde (2 Spalten auf Mobile, 1 auf MD+) -->
                    <div class="col-span-2 md:col-span-1">
                        <label for="kunde" class="block text-sm font-semibold text-gray-700">Kunde</label>
                        <input type="text" id="kunde" name="kunde" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border" placeholder="Name des Kunden">
                    </div>
                    
                    <!-- Feld: Holzart -->
                    <div class="col-span-1">
                        <label for="holzart" class="block text-sm font-semibold text-gray-700">Holzart</label>
                        <select id="holzart" name="holzart" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border bg-white">
                            <option value="Fichte">Fichte</option>
                            <option value="Tanne">Tanne</option>
                            <option value="Eiche">Eiche</option>
                            <option value="Lärche">Lärche</option>
                            <option value="Kiefer">Kiefer</option>
                        </select>
                    </div>
                    
                    <!-- Feld: Qualität (ehemals Holzklasse) -->
                    <div class="col-span-1">
                        <label for="qualitaet" class="block text-sm font-semibold text-gray-700">Qualität</label>
                        <select id="qualitaet" name="qualitaet" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border bg-white">
                            <option value="A/B">A/B</option>
                            <option value="B-Braunkern">B (Braunkern)</option>
                            <option value="CX">CX</option>
                            <option value="Käferholz">Käferholz</option>
                        </select>
                    </div>
                    
                    <!-- Feld: Länge (mit Enter-Funktion) -->
                    <div class="col-span-1">
                        <label for="laenge" class="block text-sm font-semibold text-gray-700">Länge (m)</label>
                        <input type="number" step="0.01" id="laenge" name="laenge" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border" placeholder="z.B. 4.0">
                    </div>

                    <!-- Feld: Mitteldurchmesser (mit Enter-Funktion) -->
                    <div class="col-span-1">
                        <label for="durchmesser" class="block text-sm font-semibold text-gray-700">Mitteldurchmesser (cm)</label>
                        <input type="number" step="0.1" id="durchmesser" name="durchmesser" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border" placeholder="z.B. 25.5">
                    </div>
                    
                    <!-- Feld: Netto Preis Anzeige (Ausgabe) - BEIBEHALTEN ALS FEEDBACK -->
                    <div class="col-span-1">
                        <label class="block text-sm font-semibold text-gray-700">Einzelpreis NETTO (€)</label>
                        <div id="calculated-price-netto" class="mt-1 block w-full rounded-lg shadow-sm p-3 border border-blue-200 bg-blue-50 text-blue-700 font-bold text-center">
                            0.00 €
                        </div>
                    </div>
                    
                    <!-- Feld: Brutto Preis Anzeige (Ausgabe) - BEIBEHALTEN ALS FEEDBACK -->
                    <div class="col-span-1">
                        <label class="block text-sm font-semibold text-gray-700">Einzelpreis BRUTTO (€)</label>
                        <div id="calculated-price-brutto" class="mt-1 block w-full rounded-lg shadow-sm p-3 border border-green-200 bg-green-50 text-green-700 font-bold text-center">
                            0.00 €
                        </div>
                    </div>

                    <!-- Button: Speichern (volle Breite auf Mobile, 7 Spalten auf MD+) -->
                    <div class="col-span-2 md:col-span-7 flex justify-end mt-4">
                        <button type="submit" id="save-button" class="w-full sm:w-auto px-10 py-3 text-base font-bold rounded-xl text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 shadow-md hover:shadow-lg">
                            Stamm speichern (oder Enter in Ø)
                        </button>
                    </div>
                    
                    <!-- Feedback Message -->
                    <div id="feedback-message" class="col-span-2 md:col-span-7 text-sm font-semibold hidden pt-2"></div>
                </form>
            </div>
            
            <!-- SEKTION: Eingegebene Stämme Tabelle -->
            <div class="bg-white p-6 sm:p-8 shadow-2xl rounded-xl w-full mb-12 border-t-6 border-gray-300">
                <h2 class="text-3xl font-bold text-gray-700 mb-6">Erfasste Stämme & Gutschrifts-Daten</h2>
                
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200 table-font">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Kunde</th>
                                <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Holzart</th>
                                <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Qualität</th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Länge (m)</th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Ø (cm)</th>
                                <th class="px-3 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Klassifizierung</th>
                                <th class="px-3 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Festmeter (fm)</th>
                                <!-- Spalten für Preis Netto und Brutto wurden HIER entfernt -->
                                <th class="px-3 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="wood-table-body" class="bg-white divide-y divide-gray-100">
                            <!-- Einträge werden hier dynamisch eingefügt -->
                        </tbody>
                        <tfoot>
                            <!-- Colspan auf 6 reduziert, um unter Festmeter auszurichten. -->
                            <tr class="bg-blue-50 font-extrabold border-t-2 border-blue-200">
                                <td colspan="6" class="px-3 py-3 text-right text-sm text-blue-800">Gesamtvolumen:</td>
                                <td id="total-volume" class="px-3 py-3 text-right text-sm text-blue-700">0.000 fm</td>
                                <!-- Zellen für Gesamtpreis Netto und Brutto wurden HIER entfernt -->
                                <td class="px-3 py-3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Buttons für Archivierung und PDF -->
                <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                    <div class="flex space-x-3 w-full sm:w-auto">
                        <button id="pdf-save-button" onclick="window.generatePDF()" class="w-1/2 sm:w-auto px-6 py-2.5 text-base font-semibold text-white bg-blue-600 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">
                            Gutschrift als PDF
                        </button>
                        <button id="archive-table-button" onclick="window.confirmArchive()" class="w-1/2 sm:w-auto px-6 py-2.5 text-base font-semibold text-blue-700 bg-blue-100 rounded-xl hover:bg-blue-200 transition duration-300">
                            Liste archivieren
                        </button>
                    </div>
                    <!-- Liste leeren (als Alternative zur Archivierung) -->
                    <button id="clear-table-button" onclick="window.confirmClear()" class="w-full sm:w-auto px-6 py-2.5 text-sm font-medium text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition duration-300 border border-gray-200">
                        Liste leeren (Verlust!)
                    </button>
                </div>
            </div>

            
        </div>
    </main>

    <!-- Fußzeile -->
    <footer class="bg-gray-800 text-white p-6 mt-auto">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; <span id="year"></span> Sägewerk Mülleder. Alle Rechte vorbehalten.</p>
        </div>
    </footer>
    
    <!-- Benutzerdefiniertes Bestätigungs-Modal (ersetzt prompt/confirm) -->
    <div id="confirmation-modal" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">Aktion bestätigen</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Sind Sie sicher, dass Sie diesen Vorgang durchführen möchten?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.hideConfirmation(false)" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Abbrechen
                </button>
                <button id="modal-confirm-button" onclick="window.hideConfirmation(true)" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">
                    Bestätigen
                </button>
            </div>
        </div>
    </div>


    <!-- JavaScript für die Eingabelogik, Volumenberechnung und Tabelle -->
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        // Array zur Speicherung der Holzstämme (dient als temporäre Datenbank)
        let woodEntries = JSON.parse(localStorage.getItem('woodEntries')) || [];
        const saveButton = document.getElementById('save-button');
        
        // Temporäre Variable zur Speicherung der Funktion, die nach Bestätigung ausgeführt werden soll
        let actionOnConfirm = null; 
        let actionParam = null;
        
        // Konstanter Mehrwertsteuersatz (13%)
        const MWST_RATE = 0.13;
        const MWST_FAKTOR_BRUTTO_ZU_NETTO = 1 / (1 + MWST_RATE); // 1 / 1.13

        // Statische Preisliste (Preis pro Festmeter (fm) in Euro)
        // WICHTIG: Diese Preise sind der BRUTTO-Preis (inkl. 13% MwSt.)
        const PREISLISTE = {
            'Fichte': {
                'A/B': 120.00,
                'B-Braunkern': 100.00,
                'CX': 70.00,
                'Käferholz': 50.00
            },
            'Tanne': {
                'A/B': 130.00,
                'B-Braunkern': 110.00,
                'CX': 75.00,
                'Käferholz': 55.00
            },
            'Eiche': {
                'A/B': 250.00,
                'B-Braunkern': 200.00,
                'CX': 150.00,
                'Käferholz': 100.00 
            },
            'Lärche': {
                'A/B': 150.00,
                'B-Braunkern': 130.00,
                'CX': 90.00,
                'Käferholz': 60.00
            },
            'Kiefer': {
                'A/B': 110.00,
                'B-Braunkern': 90.00,
                'CX': 65.00,
                'Käferholz': 45.00
            }
        };


        // Speichert das aktuelle Array in localStorage
        function saveEntries() {
            localStorage.setItem('woodEntries', JSON.stringify(woodEntries));
        }

        // Funktion zur Volumenberechnung (Huber-Formel / Zylindervolumen)
        function calculateVolume(length, diameter) {
            const diameterMeters = diameter / 100;
            const basalArea = Math.PI / 4 * diameterMeters * diameterMeters;
            const volume = basalArea * length;
            return volume; 
        }

        /**
         * Ruft den BRUTTO-Preis pro Festmeter (fm) basierend auf Holzart und Qualität ab.
         */
        function getBruttoPricePerFm(holzart, qualitaet) {
            // Sucht den Preis in der statischen Preisliste (BRUTTO)
            const price = PREISLISTE[holzart] ? PREISLISTE[holzart][qualitaet] : 0.00;
            return price;
        }

        /**
         * Berechnet den NETTO-Preis und den MWST-Betrag aus einem gegebenen Brutto-Preis.
         * @param {number} bruttoPrice - Der Brutto-Preis (inkl. 13% MwSt.).
         * @returns {{netto: number, mwst: number}}
         */
        function calculateNettoAndMwst(bruttoPrice) {
            const nettoPrice = bruttoPrice * MWST_FAKTOR_BRUTTO_ZU_NETTO;
            const mwstAmount = bruttoPrice - nettoPrice;
            return { netto: nettoPrice, mwst: mwstAmount };
        }

        /**
         * Berechnet den Gesamtpreis (Brutto, Netto, MwSt.) eines Stammes.
         * @param {number} festmeter - Das Volumen des Stammes in fm.
         * @param {string} holzart - Die Holzart.
         * @param {string} qualitaet - Die Qualität.
         * @returns {{brutto: number, netto: number, mwst: number}}
         */
        function calculateTotalPrice(festmeter, holzart, qualitaet) {
            const bruttoPricePerFm = getBruttoPricePerFm(holzart, qualitaet);
            const totalBruttoPrice = festmeter * bruttoPricePerFm;
            
            const { netto, mwst } = calculateNettoAndMwst(totalBruttoPrice);

            return { 
                brutto: totalBruttoPrice, 
                netto: netto, 
                mwst: mwst 
            };
        }


        /**
         * Klassifiziert das Holz basierend auf dem Mitteldurchmesser in cm.
         */
        function getClassification(diameter) {
            if (diameter >= 25) {
                return '2b+';
            } else if (diameter >= 20) {
                return '2a';
            } else if (diameter >= 15) {
                return '1b';
            } else {
                return 'UNKLAR';
            }
        }


        // Funktion zur Aktualisierung der Tabelle und der Gesamtmenge
        function renderTable() {
            const tbody = document.getElementById('wood-table-body');
            const totalVolumeElement = document.getElementById('total-volume');
            // Die Elemente für Netto/Brutto-Gesamtpreis werden nicht mehr benötigt, da sie aus der Tabelle entfernt wurden.
            tbody.innerHTML = '';
            let totalVolume = 0;
            // let totalNettoPrice = 0; // Nicht mehr in Tabelle angezeigt
            // let totalBruttoPrice = 0; // Nicht mehr in Tabelle angezeigt

            // Die Tabelle hat jetzt 8 Spalten (7 Daten + 1 Aktion)
            if (woodEntries.length === 0) {
                 const row = tbody.insertRow();
                 row.innerHTML = `<td colspan="8" class="px-3 py-4 whitespace-nowrap text-center text-sm text-gray-500 italic bg-white">Noch keine Stämme erfasst.</td>`;
            }

            woodEntries.forEach((entry, index) => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-blue-50 transition duration-100';

                // Füllt die Zeilen mit Daten
                row.insertCell().textContent = entry.kunde;
                row.insertCell().textContent = entry.holzart;
                row.insertCell().textContent = entry.qualitaet; 

                // Länge (rechtsbündig)
                const lengthCell = row.insertCell();
                lengthCell.textContent = parseFloat(entry.laenge).toFixed(2);
                lengthCell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right';
                
                // Mitteldurchmesser (rechtsbündig)
                const diameterCell = row.insertCell();
                diameterCell.textContent = parseFloat(entry.durchmesser).toFixed(1);
                diameterCell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right';
                
                // Klassifizierung (zentriert)
                const classCell = row.insertCell();
                classCell.textContent = entry.classification;
                classCell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-center font-semibold';


                // Festmeter (rechtsbündig und hervorgehoben)
                const volumeCell = row.insertCell();
                volumeCell.textContent = entry.festmeter.toFixed(3);
                volumeCell.className = 'px-3 py-2 whitespace-nowrap text-sm font-bold text-blue-700 bg-blue-100 text-right';
                
                // Preis Netto und Brutto Zellen wurden HIER entfernt.

                // Aktionen
                const actionsCell = row.insertCell();
                actionsCell.className = 'px-3 py-2 whitespace-nowrap text-right';
                actionsCell.innerHTML = `
                    <button onclick="window.editEntry(${entry.id})" class="text-blue-600 hover:text-blue-900 text-sm font-medium mr-2 transition duration-150">Ändern</button>
                    <button onclick="window.confirmDelete(${entry.id})" class="text-red-600 hover:text-red-900 text-sm font-medium transition duration-150">Löschen</button>
                `;


                totalVolume += entry.festmeter;
                // totalNettoPrice += entry.nettoPrice; 
                // totalBruttoPrice += entry.bruttoPrice; 
            });

            totalVolumeElement.textContent = `${totalVolume.toFixed(3)} fm`;
            // totalPriceNettoElement.textContent = `${totalNettoPrice.toFixed(2)} €`; // Nicht mehr in Tabelle
            // totalPriceBruttoElement.textContent = `${totalBruttoPrice.toFixed(2)} €`; // Nicht mehr in Tabelle
        }
        
        // --- MODAL FUNKTIONEN (ersetzt prompt/confirm) ---

        /**
         * Zeigt das Bestätigungs-Modal an.
         */
        window.showConfirmation = function(title, message, onConfirmAction, param = null, confirmText = 'Bestätigen') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-button').textContent = confirmText;
            
            // Setzt die Farbe des Bestätigungsbuttons je nach Aktion (Rot für Löschen/Verlust, Blau für Archivieren)
            const confirmButton = document.getElementById('modal-confirm-button');
            confirmButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-blue-600', 'hover:bg-blue-700');

            if (confirmText.includes('Löschen') || confirmText.includes('endgültig')) {
                 confirmButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                 confirmButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }

            document.getElementById('confirmation-modal').classList.remove('hidden');
            actionOnConfirm = onConfirmAction;
            actionParam = param;
        }
        
        /**
         * Versteckt das Bestätigungs-Modal und führt die Aktion aus (falls bestätigt).
         */
        window.hideConfirmation = function(confirmed) {
            document.getElementById('confirmation-modal').classList.add('hidden');
            if (confirmed && actionOnConfirm) {
                actionOnConfirm(actionParam);
            }
            // Variablen zurücksetzen
            actionOnConfirm = null;
            actionParam = null;
        }
        
        // --- LÖSCH-Logik mit Modal ---

        window.confirmDelete = function(id) {
            window.showConfirmation(
                'Stamm löschen', 
                'Sind Sie sicher, dass Sie diesen Stamm aus der Liste entfernen möchten?', 
                window.deleteEntry, 
                id,
                'Ja, Löschen'
            );
        }

        /**
         * Löscht einen Eintrag anhand seiner ID und speichert die Liste.
         */
        window.deleteEntry = function(id) {
            woodEntries = woodEntries.filter(e => e.id !== id);
            saveEntries();
            renderTable();
            
            // Feedback anzeigen
            const feedback = document.getElementById('feedback-message');
            feedback.textContent = 'Stamm erfolgreich gelöscht!';
            feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 3000);
        }


        // --- ARCHIVIERUNGS-Logik mit Modal (NEUE LOGIK) ---

        window.confirmArchive = function() {
            if (woodEntries.length === 0) {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Es gibt keine Stämme zum Archivieren.';
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 3000);
                return;
            }
            // Berechnung des Bruttopreises für die Anzeige im Modal
            const totalBruttoPrice = woodEntries.reduce((sum, entry) => sum + entry.bruttoPrice, 0);
            
            window.showConfirmation(
                'Alle Stämme archivieren', 
                `Wollen Sie wirklich alle ${woodEntries.length} erfassten Stämme (Gesamtpreis Brutto: ${totalBruttoPrice.toFixed(2)} €) archivieren und die Liste leeren? Die Daten sind danach im Archiv einsehbar.`, 
                window.handleArchive, 
                null,
                'Ja, archivieren'
            );
        }
        
        /**
         * Archiviert die aktuelle Liste, speichert sie mit einem Zeitstempel und leert die aktuelle Liste.
         */
        window.handleArchive = function() {
            const currentEntries = woodEntries;
            
            // Lade das Archiv (oder leeres Array)
            const archivedEntries = JSON.parse(localStorage.getItem('archivedEntries')) || [];
            
            // Erstelle Zeitstempel und berechne Gesamtvolumen & Preis
            const timestamp = new Date().toLocaleDateString('de-DE', { dateStyle: 'medium', timeStyle: 'short' });
            const totalVolume = currentEntries.reduce((sum, entry) => sum + entry.festmeter, 0);
            const totalNettoPrice = currentEntries.reduce((sum, entry) => sum + entry.nettoPrice, 0);
            const totalBruttoPrice = currentEntries.reduce((sum, entry) => sum + entry.bruttoPrice, 0);

            const archiveSession = {
                id: Date.now(), // Eindeutige ID für die Archiv-Sitzung
                timestamp: timestamp,
                totalVolume: totalVolume.toFixed(3),
                totalNettoPrice: totalNettoPrice.toFixed(2), 
                totalBruttoPrice: totalBruttoPrice.toFixed(2), 
                count: currentEntries.length,
                entries: currentEntries // Speichere die tatsächlichen Daten
            };
            
            // Füge die neue Sitzung vorne hinzu
            archivedEntries.unshift(archiveSession); 
            localStorage.setItem('archivedEntries', JSON.stringify(archivedEntries));

            // Leere die aktuelle Liste und speichere
            woodEntries = [];
            saveEntries();
            renderTable();
            
            // Archivierungs-Erfolgsmeldung anzeigen
            const feedback = document.getElementById('feedback-message');
            feedback.textContent = `Liste erfolgreich archiviert (${archiveSession.count} Stämme, ${archiveSession.totalBruttoPrice} € Brutto) und geleert!`;
            feedback.className = 'col-span-2 md:col-span-7 text-sm text-blue-600 font-semibold';
            setTimeout(() => feedback.classList.add('hidden'), 5000);
        }
        
        // --- LISTE LEEREN Logik mit Modal ---
        
        window.confirmClear = function() {
             if (woodEntries.length === 0) {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Die Liste ist bereits leer.';
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 3000);
                return;
            }
            window.showConfirmation(
                'Liste endgültig leeren', 
                'Sind Sie sicher, dass Sie alle Stämme OHNE Archivierung löschen möchten? Diese Daten gehen dann verloren und können NICHT wiederhergestellt werden!', 
                window.handleClear, 
                null,
                'Ja, endgültig löschen'
            );
        }

        /**
         * Löscht alle Einträge ohne Archivierung.
         */
        window.handleClear = function() {
            woodEntries = [];
            saveEntries();
            renderTable();
            
            // Erfolgsmeldung anzeigen
            const feedback = document.getElementById('feedback-message');
            feedback.textContent = 'Liste erfolgreich geleert!';
            feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 3000);
        }

        // --- PDF Generierung (MODERNISIERT) ---

        /**
         * Erzeugt eine PDF-Datei (Gutschrift) mit Zusammenfassung und Stammliste im modernen Design.
         */
        window.generatePDF = function() {
            // Überprüft, ob Einträge vorhanden sind
            if (woodEntries.length === 0) {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Keine Einträge vorhanden, um eine Gutschrift zu erstellen.';
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 4000);
                return;
            }

            // Stellt sicher, dass die PDF-Bibliotheken geladen sind
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.AcroForm === 'undefined') {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Fehler: PDF-Bibliotheken nicht geladen. Versuchen Sie es erneut.';
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 4000);
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const margin = 15;
            let y = margin;
            const today = new Date().toLocaleDateString('de-DE');
            const mainCustomer = woodEntries[0].kunde || "Unbekannter Kunde"; // Hauptkunde

            // --- 1. HEADER / BRANDING (Modernisiert) ---
            
            // Hintergrund für den Header (Lichtes Indigo)
            doc.setFillColor(219, 234, 254); // Tailwind Blue-200
            doc.rect(0, 0, doc.internal.pageSize.width, 30, 'F');
            
            // Firmenname (Sägewerk Mülleder)
            doc.setFontSize(28);
            doc.setFont('Helvetica', 'Bold');
            doc.setTextColor(30, 64, 175); // Dunkles Blau
            doc.text("Sägewerk Mülleder", margin, 21);
            
            y = 40; // Startpunkt nach dem Header

            // --- 2. DOKUMENTINFORMATIONEN ---
            
            doc.setFontSize(20);
            doc.setFont('Helvetica', 'Bold');
            doc.setTextColor(17, 24, 39); // Dunkelgrau
            doc.text("Gutschrift", margin, y);
            y += 10;

            doc.setFontSize(12);
            doc.setFont('Helvetica', 'Normal');
            doc.setTextColor(75, 85, 99); // Standardgrau
            doc.text(`Datum: ${today}`, doc.internal.pageSize.width - margin, y, { align: 'right' });
            
            doc.setFontSize(14);
            doc.setFont('Helvetica', 'Bold');
            doc.setTextColor(31, 41, 55); // Mittleres Grau
            doc.text(`Kunde: ${mainCustomer}`, margin, y);
            y += 12; 

            // Trennlinie
            doc.setDrawColor(30, 64, 175); // Dunkles Blau
            doc.setLineWidth(1);
            doc.line(margin, y, doc.internal.pageSize.width - margin, y);
            y += 10;
            
            // --- 3. VOLUMEN- UND PREIS-ZUSAMMENFASSUNG ---
            
            doc.setFontSize(16);
            doc.setFont('Helvetica', 'Bold');
            doc.setTextColor(31, 41, 55);
            doc.text("1. Gesamtübersicht nach Klassifizierung", margin, y);
            y += 5;

            // Berechnet die Summe pro Klassifizierung
            const summary = woodEntries.reduce((acc, entry) => {
                const key = entry.classification;
                acc[key] = {
                    volume: (acc[key]?.volume || 0) + entry.festmeter,
                    netto: (acc[key]?.netto || 0) + entry.nettoPrice,
                    brutto: (acc[key]?.brutto || 0) + entry.bruttoPrice,
                    mwst: (acc[key]?.mwst || 0) + entry.mwstAmount // MwSt. Betrag
                };
                return acc;
            }, {});
            
            // Bereitet die Daten für die Zusammenfassungstabelle vor und sortiert sie
            const summaryTableData = Object.entries(summary)
                .map(([classification, data]) => [
                    classification,
                    data.volume.toFixed(3) + ' fm',
                    data.netto.toFixed(2) + ' €', // Netto
                    data.mwst.toFixed(2) + ' €',  // MwSt.
                    data.brutto.toFixed(2) + ' €' // Brutto
                ])
                .sort((a, b) => a[0].localeCompare(b[0])); 

            const totalVolume = woodEntries.reduce((sum, entry) => sum + entry.festmeter, 0);
            const totalNettoPrice = woodEntries.reduce((sum, entry) => sum + entry.nettoPrice, 0);
            const totalBruttoPrice = woodEntries.reduce((sum, entry) => sum + entry.bruttoPrice, 0);
            const totalMwstAmount = woodEntries.reduce((sum, entry) => sum + entry.mwstAmount, 0);

            doc.autoTable({
                startY: y,
                head: [['Klassifizierung', 'Volumen', 'Gesamtpreis Netto', 'MwSt. (13%)', 'Gesamtpreis Brutto']],
                body: summaryTableData,
                foot: [['Gesamt', totalVolume.toFixed(3) + ' fm', totalNettoPrice.toFixed(2) + ' €', totalMwstAmount.toFixed(2) + ' €', totalBruttoPrice.toFixed(2) + ' €']],
                theme: 'grid', 
                styles: { fontSize: 11, cellPadding: 3, textColor: [55, 65, 81] },
                headStyles: { fillColor: [79, 70, 229], textColor: [255, 255, 255], fontStyle: 'bold' }, // Tailwind Indigo-600
                footStyles: { fillColor: [224, 231, 255], fontStyle: 'bold', textColor: [0, 0, 0] }, // Tailwind Indigo-200
                columnStyles: { 
                    1: { halign: 'right' }, // Volumen 
                    2: { halign: 'right' }, // Netto 
                    3: { halign: 'right' }, // MwSt.
                    4: { halign: 'right' }  // Brutto
                } 
            });

            y = doc.autoTable.previous.finalY + 15;

            // --- 4. DETAILLIERTE STAMMLISTE ---
            
            doc.setFontSize(16);
            doc.setFont('Helvetica', 'Bold');
            doc.setTextColor(31, 41, 55);
            doc.text("2. Detaillierte Stammliste", margin, y);
            y += 5;
            
            const detailTableHead = [
                'Lfd. Nr.', 
                'Holzart', 
                'Qualität', 
                'Länge (m)', 
                'Ø (cm)', 
                'Klass.', 
                'Festmeter (fm)',
                'Netto (€)', // Netto-Spalte in PDF beibehalten
                'Brutto (€)' // Brutto-Spalte in PDF beibehalten
            ];
            
            // Filtere Kunde heraus, da er bereits im Header steht, außer für die lfd. Nr.
            const detailTableBody = woodEntries.map((entry, index) => [
                index + 1, // Lfd. Nummer
                entry.holzart,
                entry.qualitaet,
                entry.laenge.toFixed(2),
                entry.durchmesser.toFixed(1),
                entry.classification,
                entry.festmeter.toFixed(3),
                entry.nettoPrice.toFixed(2), 
                entry.bruttoPrice.toFixed(2) 
            ]);

            doc.autoTable({
                startY: y,
                head: [detailTableHead],
                body: detailTableBody,
                theme: 'striped', // Streifen für bessere Lesbarkeit
                styles: { fontSize: 9, cellPadding: 2, textColor: [55, 65, 81] },
                headStyles: { fillColor: [55, 65, 81], textColor: [255, 255, 255], fontStyle: 'bold' }, // Dunkelgrau 
                columnStyles: { 
                    3: { halign: 'right' }, // Länge
                    4: { halign: 'right' }, // Durchmesser
                    6: { halign: 'right', fontStyle: 'bold' }, // Festmeter
                    7: { halign: 'right' }, // Netto
                    8: { halign: 'right', fontStyle: 'bold' } // Brutto
                },
                didDrawPage: (data) => {
                    // Footer für Seitennummerierung
                    doc.setFontSize(8);
                    doc.setFont('Helvetica', 'Italic');
                    doc.setTextColor(156, 163, 175);
                    doc.text(`Sägewerk Mülleder - Seite ${doc.internal.getNumberOfPages()}`, doc.internal.pageSize.width - margin, doc.internal.pageSize.height - 5, { align: 'right' });
                }
            });

            // Speichern der PDF
            doc.save(`Gutschrift_Sägewerk_Mülleder_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        /**
         * Lädt die Daten eines Eintrags in das Formular zum Bearbeiten.
         */
        window.editEntry = function(id) {
            const entryToEdit = woodEntries.find(e => e.id === id);
            if (entryToEdit) {
                // Formularfelder füllen
                document.getElementById('kunde').value = entryToEdit.kunde;
                document.getElementById('holzart').value = entryToEdit.holzart;
                document.getElementById('qualitaet').value = entryToEdit.qualitaet; 
                document.getElementById('laenge').value = entryToEdit.laenge;
                document.getElementById('durchmesser').value = entryToEdit.durchmesser;

                // Preis-Anzeige aktualisieren
                document.getElementById('calculated-price-netto').textContent = `${entryToEdit.nettoPrice.toFixed(2)} €`;
                document.getElementById('calculated-price-brutto').textContent = `${entryToEdit.bruttoPrice.toFixed(2)} €`;

                // ID des Eintrags speichern, um beim Speichern den richtigen Eintrag zu aktualisieren
                document.getElementById('editing-id').value = id;

                // Schaltfläche auf Bearbeitungsmodus umstellen
                saveButton.textContent = 'Änderungen speichern';
                saveButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500');
                saveButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');

                document.getElementById('kunde').focus();
            }
        }

        /**
         * Setzt das Formular in den Standardmodus (Neuer Eintrag).
         */
        function resetFormForNewEntry() {
            document.getElementById('editing-id').value = '';
            
            // Schaltfläche zurücksetzen
            saveButton.textContent = 'Stamm speichern (oder Enter in Ø)';
            saveButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
            saveButton.classList.add('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500');
        }


        document.addEventListener('DOMContentLoaded', () => {
            const laengeInput = document.getElementById('laenge');
            const durchmesserInput = document.getElementById('durchmesser');
            const holzartInput = document.getElementById('holzart');
            const qualitaetInput = document.getElementById('qualitaet');
            const form = document.getElementById('wood-entry-form');
            const feedback = document.getElementById('feedback-message');
            const editingIdInput = document.getElementById('editing-id');
            const calculatedPriceNettoDisplay = document.getElementById('calculated-price-netto');
            const calculatedPriceBruttoDisplay = document.getElementById('calculated-price-brutto');

            /**
             * Berechnet Volumen und Preis (Netto/Brutto) und aktualisiert die Preisanzeige im Formular.
             */
            function updatePriceDisplay() {
                const laenge = parseFloat(laengeInput.value);
                const durchmesser = parseFloat(durchmesserInput.value);
                const holzart = holzartInput.value;
                const qualitaet = qualitaetInput.value;

                if (isNaN(laenge) || laenge <= 0 || isNaN(durchmesser) || durchmesser <= 0) {
                    calculatedPriceNettoDisplay.textContent = '0.00 €';
                    calculatedPriceBruttoDisplay.textContent = '0.00 €';
                    return;
                }

                const festmeter = calculateVolume(laenge, durchmesser);
                const { brutto, netto } = calculateTotalPrice(festmeter, holzart, qualitaet);
                
                calculatedPriceNettoDisplay.textContent = `${netto.toFixed(2)} €`;
                calculatedPriceBruttoDisplay.textContent = `${brutto.toFixed(2)} €`;
            }

            // Event-Listener für Eingaben, um den Preis dynamisch zu aktualisieren
            const inputFields = [laengeInput, durchmesserInput, holzartInput, qualitaetInput];
            inputFields.forEach(input => {
                input.addEventListener('input', updatePriceDisplay);
            });


            // 1. Enter-Sprung von LÄNGE zu MITTELDURCHMESSER
            laengeInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && laengeInput.value) {
                    e.preventDefault(); 
                    durchmesserInput.focus();
                }
            });

            // 2. Enter-Sprung von MITTELDURCHMESSER löst SUBMIT aus und springt zurück
            durchmesserInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    form.dispatchEvent(new Event('submit', { cancelable: true })); 
                }
            });

            // 3. Formular-Verarbeitung (Speicherung und Berechnung)
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const laenge = parseFloat(laengeInput.value);
                const durchmesser = parseFloat(durchmesserInput.value);
                const holzart = holzartInput.value;
                const qualitaet = qualitaetInput.value;

                const isEditing = !!editingIdInput.value;

                // Validierung
                if (isNaN(laenge) || laenge <= 0 || isNaN(durchmesser) || durchmesser <= 0) {
                    feedback.textContent = 'Fehler: Länge/Durchmesser fehlen oder sind ungültig!';
                    feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
                    feedback.classList.remove('hidden');
                    setTimeout(() => feedback.classList.add('hidden'), 4000);
                    
                    if (isNaN(laenge) || laenge <= 0) laengeInput.focus();
                    else durchmesserInput.focus();
                    
                    return; 
                }

                const festmeter = calculateVolume(laenge, durchmesser);
                const classification = getClassification(durchmesser); 
                const { brutto, netto, mwst } = calculateTotalPrice(festmeter, holzart, qualitaet); // NEU: Brutto/Netto/MwSt

                const newEntry = {
                    kunde: document.getElementById('kunde').value || 'Unbekannt',
                    holzart: holzart,
                    qualitaet: qualitaet,
                    laenge: laenge,
                    durchmesser: durchmesser,
                    festmeter: festmeter,
                    classification: classification,
                    bruttoPrice: brutto,
                    nettoPrice: netto,
                    mwstAmount: mwst
                };
                
                let originalLaenge = laengeInput.value; 

                if (isEditing) {
                    // Bearbeiten
                    const id = parseInt(editingIdInput.value);
                    const index = woodEntries.findIndex(e => e.id === id);
                    
                    if (index !== -1) {
                        woodEntries[index] = { ...newEntry, id: id };
                        feedback.textContent = 'Eintrag erfolgreich aktualisiert!';
                    }
                    // Nach Bearbeitung Formular zurücksetzen, da es sich meist um einen einzelnen Korrekturvorgang handelt
                    resetFormForNewEntry(); 
                    
                    // Setzt den Fokus nach der Bearbeitung auf das Kundenfeld, um die Eingabesequenz neu zu starten
                    document.getElementById('kunde').focus();
                } else {
                    // Neuer Eintrag
                    newEntry.id = Date.now(); 
                    woodEntries.push(newEntry);
                    feedback.textContent = 'Eintrag erfolgreich gespeichert und zur Tabelle hinzugefügt!';
                    
                    // Logik: Länge beibehalten und Durchmesser zurücksetzen
                    durchmesserInput.value = ''; // Durchmesser löschen
                    laengeInput.value = originalLaenge; // Länge beibehalten
                    durchmesserInput.focus(); // Fokus auf Durchmesser setzen
                }


                // Speichern, Tabelle neu rendern
                saveEntries();
                renderTable();
                updatePriceDisplay(); // Preis-Anzeige für nächste Eingabe aktualisieren

                // Feedback anzeigen
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-green-600 font-semibold';
                feedback.classList.remove('hidden');
                
                // Feedback nach 3 Sekunden ausblenden
                setTimeout(() => feedback.classList.add('hidden'), 3000);
            });
            
            // Initialer Aufruf
            renderTable();
            updatePriceDisplay(); // Setzt den initialen Preis auf 0.00 €
            
            // Setzt den anfänglichen Fokus
            document.getElementById('kunde').focus();
        });
    </script>
</body>
</html>
