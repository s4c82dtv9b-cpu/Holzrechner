<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Einbindung von Tailwind CSS für Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Einbindung der jspdf-Bibliotheken für PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Setzt die Standard-Schriftart auf Inter und sorgt für eine fließende Höhe */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Definiert eine schmale Schriftart für die Tabelle, falls auf mobilen Geräten benötigt */
        .table-font {
            font-size: 0.8rem;
        }
        /* Stellt sicher, dass das Modal über allem liegt */
        .modal-overlay {
            z-index: 50; 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Navigationsleiste -->
    <nav class="bg-white shadow-lg p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <!-- Logo oder Markenname -->
            <a href="index.html" class="text-xl font-bold text-indigo-600">Sägewerk Mülleder</a>
            <!-- Navigationslinks mit ARCHIV -->
            <div class="flex space-x-4">
                <a href="index.html" class="text-indigo-600 font-semibold hover:text-indigo-800 transition duration-300 border-b-2 border-indigo-600 pb-1">Dashboard</a>
                <a href="archiv.html" class="text-gray-600 hover:text-indigo-600 font-semibold transition duration-300">Archiv</a>
                <a href="kunden.html" class="text-gray-600 hover:text-indigo-600 transition duration-300">Kunden</a>
                <a href="preise.html" class="text-gray-600 hover:text-indigo-600 transition duration-300">Preise</a>
            </div>
        </div>
    </nav>

    <!-- Hauptinhalt (Dashboard Ansicht) -->
    <main class="flex-grow container mx-auto p-8">
        <div class="w-full max-w-5xl mx-auto">
            <!-- TITEL WIE GEWÜNSCHT GEÄNDERT UND GRÜN MARKIERT -->
            <h1 class="text-4xl font-extrabold text-green-700 mb-8 text-center sm:text-left">
                Holzrechner Sägewerk Mülleder
            </h1>

            <!-- SEKTION: Schnelle Datenerfassung für Holzstämme -->
            <div class="bg-white p-8 shadow-xl rounded-xl w-full mb-8 border-t-4 border-indigo-500">
                <h2 class="text-3xl font-bold text-indigo-700 mb-6">Schnelle Stammdaten erfassen</h2>
                
                <form id="wood-entry-form" class="grid grid-cols-2 md:grid-cols-5 gap-6 items-end">
                    
                    <!-- Verstecktes Feld zur Speicherung der ID bei Bearbeitung -->
                    <input type="hidden" id="editing-id" value="">
                    
                    <!-- Feld: Kunde -->
                    <div class="col-span-2 md:col-span-1">
                        <label for="kunde" class="block text-sm font-medium text-gray-700">Kunde</label>
                        <input type="text" id="kunde" name="kunde" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border" placeholder="Name des Kunden">
                    </div>
                    
                    <!-- Feld: Holzart -->
                    <div class="col-span-1">
                        <label for="holzart" class="block text-sm font-medium text-gray-700">Holzart</label>
                        <select id="holzart" name="holzart" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border bg-white">
                            <option value="Fichte">Fichte</option>
                            <option value="Tanne">Tanne</option>
                            <option value="Eiche">Eiche</option>
                            <option value="Lärche">Lärche</option>
                            <option value="Kiefer">Kiefer</option>
                        </select>
                    </div>
                    
                    <!-- Feld: Qualität (ehemals Holzklasse) -->
                    <div class="col-span-1">
                        <label for="qualitaet" class="block text-sm font-medium text-gray-700">Qualität</label>
                        <select id="qualitaet" name="qualitaet" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border bg-white">
                            <option value="A/B">A/B</option>
                            <option value="B-Braunkern">B (Braunkern)</option>
                            <option value="CX">CX</option>
                            <option value="Käferholz">Käferholz</option>
                        </select>
                    </div>
                    
                    <!-- Feld: Länge (mit Enter-Funktion) -->
                    <div class="col-span-1">
                        <label for="laenge" class="block text-sm font-medium text-gray-700">Länge (m)</label>
                        <input type="number" step="0.01" id="laenge" name="laenge" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border" placeholder="z.B. 4.0">
                    </div>

                    <!-- Feld: Mitteldurchmesser (mit Enter-Funktion) -->
                    <div class="col-span-1">
                        <label for="durchmesser" class="block text-sm font-medium text-gray-700">Mitteldurchmesser (cm)</label>
                        <input type="number" step="0.1" id="durchmesser" name="durchmesser" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border" placeholder="z.B. 25.5">
                    </div>

                    <!-- Button: Speichern (wird hauptsächlich durch Enter ausgelöst) -->
                    <div class="col-span-2 md:col-span-5 flex justify-end">
                        <button type="submit" id="save-button" class="w-full sm:w-auto px-8 py-2.5 border border-transparent text-base font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                            Stamm speichern (oder Enter in Mitteldurchmesser)
                        </button>
                    </div>
                    
                    <!-- Feedback Message -->
                    <div id="feedback-message" class="col-span-2 md:col-span-5 text-sm text-green-600 font-medium hidden">Eintrag erfolgreich gespeichert und zur Tabelle hinzugefügt!</div>
                </form>
            </div>
            
            <!-- NEUE SEKTION: Eingegebene Stämme Tabelle -->
            <div class="bg-white p-8 shadow-xl rounded-xl w-full mb-12">
                <h2 class="text-3xl font-bold text-gray-700 mb-6">Erfasste Stämme</h2>
                
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200 table-font">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kunde</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Holzart</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qualität</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Länge (m)</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø (cm)</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Klassifizierung</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Festmeter (fm)</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="wood-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Einträge werden hier dynamisch eingefügt -->
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 font-bold">
                                <!-- Colspan auf 6 erhöht (Kunde, Holzart, Qualität, Länge, Ø, Klassifizierung) -->
                                <td colspan="6" class="px-3 py-2 text-right text-sm text-gray-800">Gesamtvolumen:</td>
                                <td id="total-volume" class="px-3 py-2 text-right text-sm text-indigo-700">0.000 fm</td>
                                <td class="px-3 py-2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Buttons für Archivierung und PDF -->
                <div class="mt-4 flex justify-between items-center">
                    <div>
                        <button id="archive-table-button" onclick="window.confirmArchive()" class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200 transition duration-300 mr-4">
                            Alles archivieren
                        </button>
                        <button id="pdf-save-button" onclick="window.generatePDF()" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition duration-300">
                            Als PDF speichern (Gutschrift)
                        </button>
                    </div>
                    <!-- Liste leeren (als Alternative zur Archivierung) -->
                    <button id="clear-table-button" onclick="window.confirmClear()" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-300">
                        Liste leeren
                    </button>
                </div>
            </div>

            <!-- Bestehende Dashboard Karten (Zugriff auf Kunden und Preise) -->
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Übersichten</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Dashboard Card 1: Kunden -->
                <a href="kunden.html" class="block bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:-translate-y-1 border-b-4 border-indigo-500">
                    <div class="flex items-start space-x-4">
                        <svg class="w-10 h-10 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2a3 3 0 00-5.356-1.857M9 20V8m3.934 1.5l.399 2.074-2.22 1.354 2.22 1.354-.399 2.074M6 20V8m0 0v12m3-12h2m-2 0h-2M9 8h2m-2 0H7"></path></svg>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Kunden & Testimonials</h2>
                            <p class="text-gray-600">
                                Sehen Sie sich unsere Partner und Referenzen an. Hier finden Sie alle Erfolgsgeschichten unserer Kunden.
                            </p>
                            <span class="mt-4 inline-block text-indigo-500 font-semibold hover:text-indigo-700">
                                Zur Kundenseite →
                            </span>
                        </div>
                    </div>
                </a>

                <!-- Dashboard Card 2: Preise -->
                <a href="preise.html" class="block bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:-translate-y-1 border-b-4 border-indigo-500">
                    <div class="flex items-start space-x-4">
                        <svg class="w-10 h-10 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Preise & Tarife</h2>
                            <p class="text-gray-600">
                                Entdecken Sie unsere verschiedenen Pakete und finden Sie den passenden Tarif für Ihre Bedürfnisse.
                            </p>
                            <span class="mt-4 inline-block text-indigo-500 font-semibold hover:text-indigo-700">
                                Zur Preisübersicht →
                            </span>
                        </div>
                    </div>
                </a>
            </div>
            
        </div>
    </main>

    <!-- Fußzeile -->
    <footer class="bg-gray-800 text-white p-4 mt-auto">
        <div class="container mx-auto text-center text-sm">
            <!-- Das Jahr wird dynamisch eingefügt -->
            <p>&copy; <span id="year"></span> Sägewerk Mülleder. Alle Rechte vorbehalten.</p>
        </div>
    </footer>
    
    <!-- NEU: Benutzerdefiniertes Bestätigungs-Modal (ersetzt prompt/confirm) -->
    <div id="confirmation-modal" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">Aktion bestätigen</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Sind Sie sicher, dass Sie diesen Vorgang durchführen möchten?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.hideConfirmation(false)" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Abbrechen
                </button>
                <button id="modal-confirm-button" onclick="window.hideConfirmation(true)" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">
                    Bestätigen
                </button>
            </div>
        </div>
    </div>


    <!-- JavaScript für die Eingabelogik, Volumenberechnung und Tabelle -->
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        // Array zur Speicherung der Holzstämme (dient als temporäre Datenbank)
        let woodEntries = JSON.parse(localStorage.getItem('woodEntries')) || [];
        const saveButton = document.getElementById('save-button');
        
        // Temporäre Variable zur Speicherung der Funktion, die nach Bestätigung ausgeführt werden soll
        let actionOnConfirm = null; 
        let actionParam = null;


        // Speichert das aktuelle Array in localStorage
        function saveEntries() {
            localStorage.setItem('woodEntries', JSON.stringify(woodEntries));
        }

        // Funktion zur Volumenberechnung (Huber-Formel / Zylindervolumen)
        function calculateVolume(length, diameter) {
            const diameterMeters = diameter / 100;
            const basalArea = Math.PI / 4 * diameterMeters * diameterMeters;
            const volume = basalArea * length;
            return volume; 
        }

        /**
         * Klassifiziert das Holz basierend auf dem Mitteldurchmesser in cm.
         */
        function getClassification(diameter) {
            if (diameter >= 25) {
                return '2b+';
            } else if (diameter >= 20) {
                return '2a';
            } else if (diameter >= 15) {
                return '1b';
            } else {
                return 'UNKLAR';
            }
        }


        // Funktion zur Aktualisierung der Tabelle und der Gesamtmenge
        function renderTable() {
            const tbody = document.getElementById('wood-table-body');
            const totalVolumeElement = document.getElementById('total-volume');
            tbody.innerHTML = '';
            let totalVolume = 0;

            // Colspan ist 8 (8 Spalten insgesamt)
            if (woodEntries.length === 0) {
                 const row = tbody.insertRow();
                 row.innerHTML = `<td colspan="8" class="px-3 py-4 whitespace-nowrap text-center text-sm text-gray-500 italic">Noch keine Stämme erfasst.</td>`;
            }

            woodEntries.forEach((entry, index) => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50 transition duration-100';

                // Füllt die Zeilen mit Daten
                row.insertCell().textContent = entry.kunde;
                row.insertCell().textContent = entry.holzart;
                row.insertCell().textContent = entry.qualitaet; 

                // Länge (rechtsbündig)
                const lengthCell = row.insertCell();
                lengthCell.textContent = parseFloat(entry.laenge).toFixed(2);
                lengthCell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right';
                
                // Mitteldurchmesser (rechtsbündig)
                const diameterCell = row.insertCell();
                diameterCell.textContent = parseFloat(entry.durchmesser).toFixed(1);
                diameterCell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right';
                
                // Klassifizierung (zentriert)
                const classCell = row.insertCell();
                classCell.textContent = entry.classification;
                classCell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-center font-semibold';


                // Festmeter (rechtsbündig und hervorgehoben)
                const volumeCell = row.insertCell();
                volumeCell.textContent = entry.festmeter.toFixed(3);
                volumeCell.className = 'px-3 py-2 whitespace-nowrap text-sm font-medium text-indigo-700 bg-indigo-50 text-right';

                // Aktionen
                const actionsCell = row.insertCell();
                actionsCell.className = 'px-3 py-2 whitespace-nowrap text-right';
                actionsCell.innerHTML = `
                    <button onclick="window.editEntry(${entry.id})" class="text-indigo-600 hover:text-indigo-900 text-sm font-medium mr-2">Ändern</button>
                    <button onclick="window.confirmDelete(${entry.id})" class="text-red-600 hover:text-red-900 text-sm font-medium">Löschen</button>
                `;


                totalVolume += entry.festmeter;
            });

            totalVolumeElement.textContent = `${totalVolume.toFixed(3)} fm`;
        }
        
        // --- MODAL FUNKTIONEN (ersetzt prompt/confirm) ---

        /**
         * Zeigt das Bestätigungs-Modal an.
         */
        window.showConfirmation = function(title, message, onConfirmAction, param = null, confirmText = 'Bestätigen') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-button').textContent = confirmText;
            document.getElementById('confirmation-modal').classList.remove('hidden');
            actionOnConfirm = onConfirmAction;
            actionParam = param;
        }
        
        /**
         * Versteckt das Bestätigungs-Modal und führt die Aktion aus (falls bestätigt).
         */
        window.hideConfirmation = function(confirmed) {
            document.getElementById('confirmation-modal').classList.add('hidden');
            if (confirmed && actionOnConfirm) {
                actionOnConfirm(actionParam);
            }
            // Variablen zurücksetzen
            actionOnConfirm = null;
            actionParam = null;
        }
        
        // --- LÖSCH-Logik mit Modal ---

        window.confirmDelete = function(id) {
            window.showConfirmation(
                'Stamm löschen', 
                'Sind Sie sicher, dass Sie diesen Stamm aus der Liste entfernen möchten?', 
                window.deleteEntry, 
                id,
                'Löschen'
            );
        }

        /**
         * Löscht einen Eintrag anhand seiner ID und speichert die Liste.
         */
        window.deleteEntry = function(id) {
            woodEntries = woodEntries.filter(e => e.id !== id);
            saveEntries();
            renderTable();
            
            // Feedback anzeigen
            const feedback = document.getElementById('feedback-message');
            feedback.textContent = 'Stamm erfolgreich gelöscht!';
            feedback.className = 'col-span-2 md:col-span-5 text-sm text-red-600 font-medium';
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 3000);
        }


        // --- ARCHIVIERUNGS-Logik mit Modal (NEUE LOGIK) ---

        window.confirmArchive = function() {
            if (woodEntries.length === 0) {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Es gibt keine Stämme zum Archivieren.';
                feedback.className = 'col-span-2 md:col-span-5 text-sm text-red-600 font-medium';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 3000);
                return;
            }
            window.showConfirmation(
                'Alle Stämme archivieren', 
                `Wollen Sie wirklich alle ${woodEntries.length} erfassten Stämme archivieren und die Liste leeren? Die Daten sind danach im Archiv einsehbar.`, 
                window.handleArchive, 
                null,
                'Ja, archivieren'
            );
        }
        
        /**
         * Archiviert die aktuelle Liste, speichert sie mit einem Zeitstempel und leert die aktuelle Liste.
         */
        window.handleArchive = function() {
            const currentEntries = woodEntries;
            
            // Lade das Archiv (oder leeres Array)
            const archivedEntries = JSON.parse(localStorage.getItem('archivedEntries')) || [];
            
            // Erstelle Zeitstempel und berechne Gesamtvolumen
            const timestamp = new Date().toLocaleString('de-DE', { dateStyle: 'medium', timeStyle: 'short' });
            const totalVolume = currentEntries.reduce((sum, entry) => sum + entry.festmeter, 0);

            const archiveSession = {
                id: Date.now(), // Eindeutige ID für die Archiv-Sitzung
                timestamp: timestamp,
                totalVolume: totalVolume.toFixed(3),
                count: currentEntries.length,
                entries: currentEntries // Speichere die tatsächlichen Daten
            };
            
            // Füge die neue Sitzung vorne hinzu
            archivedEntries.unshift(archiveSession); 
            localStorage.setItem('archivedEntries', JSON.stringify(archivedEntries));

            // Leere die aktuelle Liste und speichere
            woodEntries = [];
            saveEntries();
            renderTable();
            
            // Archivierungs-Erfolgsmeldung anzeigen
            const feedback = document.getElementById('feedback-message');
            feedback.textContent = `Liste erfolgreich archiviert (${archiveSession.count} Stämme, ${archiveSession.totalVolume} fm) und geleert!`;
            feedback.className = 'col-span-2 md:col-span-5 text-sm text-blue-600 font-medium';
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 5000);
        }
        
        // --- LISTE LEEREN Logik mit Modal ---
        
        window.confirmClear = function() {
             if (woodEntries.length === 0) {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Die Liste ist bereits leer.';
                feedback.className = 'col-span-2 md:col-span-5 text-sm text-red-600 font-medium';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 3000);
                return;
            }
            window.showConfirmation(
                'Liste leeren', 
                'Sind Sie sicher, dass Sie alle Stämme OHNE Archivierung löschen möchten? Diese Daten gehen dann verloren!', 
                window.handleClear, 
                null,
                'Ja, endgültig löschen'
            );
        }

        /**
         * Löscht alle Einträge ohne Archivierung.
         */
        window.handleClear = function() {
            woodEntries = [];
            saveEntries();
            renderTable();
            
            // Erfolgsmeldung anzeigen
            const feedback = document.getElementById('feedback-message');
            feedback.textContent = 'Liste erfolgreich geleert!';
            feedback.className = 'col-span-2 md:col-span-5 text-sm text-red-600 font-medium';
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 3000);
        }

        // --- PDF Generierung ---

        /**
         * Erzeugt eine PDF-Datei (Gutschrift) mit Zusammenfassung und Stammliste.
         */
        window.generatePDF = function() {
            // Überprüft, ob Einträge vorhanden sind
            if (woodEntries.length === 0) {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Keine Einträge vorhanden, um eine Gutschrift zu erstellen.';
                feedback.className = 'col-span-2 md:col-span-5 text-sm text-red-600 font-medium';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 4000);
                return;
            }

            // Stellt sicher, dass die PDF-Bibliotheken geladen sind
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.AcroForm === 'undefined') {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Fehler: PDF-Bibliotheken nicht geladen. Versuchen Sie es erneut.';
                feedback.className = 'col-span-2 md:col-span-5 text-sm text-red-600 font-medium';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 4000);
                return;
            }
            
            // Initialisiert jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;
            const margin = 15;
            
            // --- 1. FIRMENNAME ---
            doc.setFontSize(24);
            doc.text("Sägewerk Mülleder", margin, y);
            y += 5;

            // --- 2. Titel & Datum ---
            doc.setFontSize(18);
            doc.text("Gutschrift", margin, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')} | Gesamte Stämme: ${woodEntries.length}`, margin, y);
            y += 10;
            
            // --- 3. Klassifizierungs-Zusammenfassung ---
            doc.setFontSize(16);
            doc.text("Volumen-Zusammenfassung nach Klassifizierung", margin, y);
            y += 5;

            // Berechnet die Summe pro Klassifizierung
            const summary = woodEntries.reduce((acc, entry) => {
                const key = entry.classification;
                acc[key] = (acc[key] || 0) + entry.festmeter;
                return acc;
            }, {});
            
            // Bereitet die Daten für die Zusammenfassungstabelle vor und sortiert sie
            const summaryTableData = Object.entries(summary)
                .map(([classification, volume]) => [
                    classification,
                    volume.toFixed(3) + ' fm'
                ])
                .sort((a, b) => a[0].localeCompare(b[0])); // Sortiert alphabetisch nach Klassifizierung

            // Gesamtvolumen berechnen
            const totalVolume = summaryTableData.reduce((sum, row) => sum + parseFloat(row[1]), 0);

            doc.autoTable({
                startY: y,
                head: [['Klassifizierung', 'Gesamtvolumen (fm)']],
                body: summaryTableData,
                foot: [['Gesamt', totalVolume.toFixed(3) + ' fm']],
                theme: 'striped',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [50, 50, 80], halign: 'center' },
                footStyles: { fillColor: [200, 200, 200], fontStyle: 'bold' },
                columnStyles: { 1: { halign: 'right' } }
            });

            y = doc.autoTable.previous.finalY + 15;

            // --- 4. Detaillierte Stammliste ---
            doc.setFontSize(16);
            doc.text("Detaillierte Stammliste", margin, y);
            y += 5;
            
            // Bereitet die Daten für die Detailtabelle vor
            const detailTableHead = [
                'ID', 
                'Kunde', 
                'Holzart', 
                'Qualität', 
                'Länge (m)', 
                'Ø (cm)', 
                'Klass.', 
                'Festmeter (fm)'
            ];
            
            const detailTableBody = woodEntries.map((entry, index) => [
                index + 1, // Einfache lfd. ID für das PDF
                entry.kunde,
                entry.holzart,
                entry.qualitaet,
                entry.laenge.toFixed(2),
                entry.durchmesser.toFixed(1),
                entry.classification,
                entry.festmeter.toFixed(3)
            ]);

            doc.autoTable({
                startY: y,
                head: [detailTableHead],
                body: detailTableBody,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [100, 100, 100] },
                columnStyles: { 
                    4: { halign: 'right' }, 
                    5: { halign: 'right' }, 
                    7: { halign: 'right' } 
                },
                didDrawPage: (data) => {
                    doc.setFontSize(8);
                    doc.text("Seite " + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 5);
                }
            });

            // Speichern der PDF
            doc.save(`Gutschrift_Sägewerk_Mülleder_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        /**
         * Lädt die Daten eines Eintrags in das Formular zum Bearbeiten.
         */
        window.editEntry = function(id) {
            const entryToEdit = woodEntries.find(e => e.id === id);
            if (entryToEdit) {
                // Formularfelder füllen
                document.getElementById('kunde').value = entryToEdit.kunde;
                document.getElementById('holzart').value = entryToEdit.holzart;
                document.getElementById('qualitaet').value = entryToEdit.qualitaet; 
                document.getElementById('laenge').value = entryToEdit.laenge;
                document.getElementById('durchmesser').value = entryToEdit.durchmesser;

                // ID des Eintrags speichern, um beim Speichern den richtigen Eintrag zu aktualisieren
                document.getElementById('editing-id').value = id;

                // Schaltfläche auf Bearbeitungsmodus umstellen
                saveButton.textContent = 'Änderungen speichern';
                saveButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500');
                saveButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500');

                document.getElementById('kunde').focus();
            }
        }

        /**
         * Setzt das Formular in den Standardmodus (Neuer Eintrag).
         */
        function resetFormForNewEntry() {
            document.getElementById('editing-id').value = '';
            
            // Hier wird nichts zurückgesetzt, da die Formularwerte beim Speichern 
            // gemäß der Logik direkt manipuliert werden, wenn nicht im Bearbeitungsmodus.
            
            // Schaltfläche zurücksetzen
            saveButton.textContent = 'Stamm speichern (oder Enter in Mitteldurchmesser)';
            saveButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500');
            saveButton.classList.add('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500');
        }


        document.addEventListener('DOMContentLoaded', () => {
            const laengeInput = document.getElementById('laenge');
            const durchmesserInput = document.getElementById('durchmesser');
            const form = document.getElementById('wood-entry-form');
            const feedback = document.getElementById('feedback-message');
            const editingIdInput = document.getElementById('editing-id');


            // 1. Enter-Sprung von LÄNGE zu MITTELDURCHMESSER
            laengeInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && laengeInput.value) {
                    e.preventDefault(); 
                    durchmesserInput.focus();
                }
            });

            // 2. Enter-Sprung von MITTELDURCHMESSER löst SUBMIT aus und springt zurück
            durchmesserInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    form.dispatchEvent(new Event('submit', { cancelable: true })); 
                }
            });

            // 3. Formular-Verarbeitung (Speicherung und Berechnung)
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const laenge = parseFloat(laengeInput.value);
                const durchmesser = parseFloat(durchmesserInput.value);
                const isEditing = !!editingIdInput.value;

                // Validierung
                if (isNaN(laenge) || laenge <= 0 || isNaN(durchmesser) || durchmesser <= 0) {
                    feedback.textContent = 'Fehler: Länge/Durchmesser fehlen oder sind ungültig!';
                    feedback.className = 'col-span-2 md:col-span-5 text-sm text-red-600 font-medium';
                    feedback.classList.remove('hidden');
                    setTimeout(() => feedback.classList.add('hidden'), 4000);
                    
                    if (isNaN(laenge) || laenge <= 0) laengeInput.focus();
                    else durchmesserInput.focus();
                    
                    return; 
                }

                const festmeter = calculateVolume(laenge, durchmesser);
                const classification = getClassification(durchmesser); // KLASSIFIZIERUNG

                const newEntry = {
                    kunde: document.getElementById('kunde').value || 'Unbekannt',
                    holzart: document.getElementById('holzart').value,
                    qualitaet: document.getElementById('qualitaet').value,
                    laenge: laenge,
                    durchmesser: durchmesser,
                    festmeter: festmeter,
                    classification: classification // KLASSIFIZIERUNG SPEICHERN
                };
                
                let originalLaenge = laengeInput.value; // Speichert den Wert der Länge vor dem Reset

                if (isEditing) {
                    // Bearbeiten
                    const id = parseInt(editingIdInput.value);
                    const index = woodEntries.findIndex(e => e.id === id);
                    
                    if (index !== -1) {
                        woodEntries[index] = { ...newEntry, id: id };
                        feedback.textContent = 'Eintrag erfolgreich aktualisiert!';
                    }
                    // Nach Bearbeitung Formular zurücksetzen, da es sich meist um einen einzelnen Korrekturvorgang handelt
                    resetFormForNewEntry(); 
                    // Setzt den Fokus nach der Bearbeitung auf das Kundenfeld, um die Eingabesequenz neu zu starten
                    document.getElementById('kunde').focus();
                } else {
                    // Neuer Eintrag
                    newEntry.id = Date.now(); 
                    woodEntries.push(newEntry);
                    feedback.textContent = 'Eintrag erfolgreich gespeichert und zur Tabelle hinzugefügt!';
                    
                    // Logik: Länge beibehalten und Durchmesser zurücksetzen
                    durchmesserInput.value = ''; // Durchmesser löschen
                    laengeInput.value = originalLaenge; // Länge beibehalten
                    durchmesserInput.focus(); // Fokus auf Durchmesser setzen
                }


                // Speichern, Tabelle neu rendern
                saveEntries();
                renderTable();

                // Feedback anzeigen
                feedback.className = 'col-span-2 md:col-span-5 text-sm text-green-600 font-medium';
                feedback.classList.remove('hidden');
                
                // Feedback nach 3 Sekunden ausblenden
                setTimeout(() => feedback.classList.add('hidden'), 3000);
            });
            
            // Initialer Aufruf
            renderTable();
            
            // Setzt den anfänglichen Fokus
            document.getElementById('kunde').focus();
        });
    </script>
</body>
</html>
