<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holzrechner Dashboard (Geschützt)</title>
    <!-- Einbindung von Tailwind CSS für Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Einbindung der jspdf-Bibliotheken für PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Setzt die Standard-Schriftart auf Inter und sorgt für eine fließende Höhe */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Definiert eine schmale Schriftart für die Tabelle, falls auf mobilen Geräten benötigt */
        .table-font {
            font-size: 0.8rem;
        }
        /* Stellt sicher, dass das Modal über allem liegt */
        .modal-overlay {
            z-index: 50; 
        }
        /* Definiert die Farben für die Status-Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.65rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .status-badge.aktiv {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .status-badge.inaktiv {
            background-color: #f3f4f6; /* gray-100 */
            color: #4b5563; /* gray-600 */
        }
        .status-badge.neu {
            background-color: #bfdbfe; /* blue-100 */
            color: #1e40af; /* blue-800 */
        }
        .status-badge.in_bearbeitung {
            background-color: #fef3c7; /* yellow-100 */
            color: #92400e; /* yellow-800 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Navigationsleiste -->
    <nav class="bg-white shadow-xl p-4 sticky top-0 z-30 border-b-4 border-teal-600">
        <div class="container mx-auto flex justify-between items-center max-w-7xl">
            <a href="index.html" class="text-2xl font-extrabold text-teal-700 tracking-wide">Holzrechner Mülleder</a>
            <div class="flex space-x-4">
                <a href="index.html" class="text-teal-700 font-bold hover:text-teal-800 transition duration-300 border-b-2 border-teal-700 pb-1">Startseite (Rechner)</a>
                <a href="kunden.html" class="text-gray-600 hover:text-teal-700 transition duration-300 font-medium">Kunden</a>
                <a href="#" class="text-gray-600 hover:text-teal-700 transition duration-300 font-medium">Archiv (i.E.)</a>
            </div>
        </div>
    </nav>

    <!-- Hauptinhalt (Layout: Eingabe links, Dashboard rechts) -->
    <main class="flex-grow container mx-auto p-4 sm:p-8 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- LINKER BEREICH: Holzrechner Eingabe und Liste (2/3) -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Header / Aktuelle Bestellung -->
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-200">
                    <h1 class="text-3xl font-extrabold text-teal-800 mb-2">Aktuelle Holzliste</h1>
                    <p class="text-lg text-gray-600">Erfassen und verwalten Sie die Stämme der aktuellen Lieferung.</p>
                    
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div class="mb-2 md:mb-0">
                            <label for="kunde" class="block text-xs font-bold text-blue-800 uppercase">Kunde (Verpflichtend)</label>
                            <!-- Eingabe-Dropdown für Kunden -->
                            <select id="kunde" required class="mt-1 block w-full md:w-80 rounded-lg border-blue-300 shadow-md focus:border-blue-500 focus:ring-blue-500 p-3 border bg-white text-gray-700">
                                <option value="" disabled selected>Kunden auswählen...</option>
                            </select>
                        </div>
                        <div id="customer-status-badge">
                            <!-- Hier wird der Kundenstatus angezeigt -->
                        </div>
                    </div>

                </div>

                <!-- FORMULAR: Stammdaten-Eingabe -->
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-200">
                    <h2 class="text-xl font-bold text-teal-700 mb-4 border-b pb-2">Stamm erfassen</h2>
                    <form id="wood-entry-form" class="grid grid-cols-2 md:grid-cols-7 gap-4 items-center">
                        
                        <!-- Verstecktes Feld für ID bei Bearbeitung -->
                        <input type="hidden" id="editing-id" value="">
                        
                        <!-- Baumart/Güte -->
                        <div class="col-span-1 md:col-span-2">
                            <label for="baumart" class="block text-xs font-bold text-gray-700">Baumart/Güte</label>
                            <select id="baumart" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-3 border bg-white">
                                <option value="Fichte A">Fichte A</option>
                                <option value="Fichte B">Fichte B</option>
                                <option value="Tanne">Tanne</option>
                                <option value="Kiefer">Kiefer</option>
                                <option value="Lärche">Lärche</option>
                                <option value="Eiche">Eiche</option>
                                <option value="Buche">Buche</option>
                                <option value="Sonstige">Sonstige</option>
                            </select>
                        </div>

                        <!-- Länge (Laufmeter) -->
                        <div class="col-span-1 md:col-span-1">
                            <label for="laenge" class="block text-xs font-bold text-gray-700">Länge (m)</label>
                            <input type="number" id="laenge" required step="0.01" min="0.5" placeholder="z.B. 4.10" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-3 border">
                        </div>

                        <!-- Durchmesser (cm) -->
                        <div class="col-span-1 md:col-span-1">
                            <label for="durchmesser" class="block text-xs font-bold text-gray-700">Durchmesser (cm)</label>
                            <input type="number" id="durchmesser" required step="1" min="10" placeholder="z.B. 25" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-3 border">
                        </div>

                        <!-- Notizen -->
                        <div class="col-span-1 md:col-span-2">
                            <label for="notizen" class="block text-xs font-bold text-gray-700">Notizen (optional)</label>
                            <input type="text" id="notizen" placeholder="z.B. Bläue, Käferholz" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-3 border">
                        </div>

                        <!-- Button -->
                        <div class="col-span-2 md:col-span-1 pt-4 md:pt-6">
                            <button type="submit" id="submit-button" class="w-full px-4 py-3 text-sm font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                                Hinzufügen
                            </button>
                        </div>

                        <!-- Feedback-Nachricht -->
                        <div id="feedback-message" class="hidden"></div>
                    </form>
                </div>
                
                <!-- Tabelle: Erfasste Stämme -->
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-200">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-bold text-teal-700">Erfasste Stämme (<span id="total-stamme">0</span>)</h2>
                        <button id="clear-list-button" class="px-3 py-1 text-sm font-medium text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition duration-200 shadow-sm">
                            Liste löschen
                        </button>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200 table-font">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Lauf. Nr.</th>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Baumart/Güte</th>
                                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Länge (m)</th>
                                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Durchmesser (cm)</th>
                                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Festmeter (FM)</th>
                                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Notizen</th>
                                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="wood-table-body" class="bg-white divide-y divide-gray-100">
                                <!-- Daten werden hier eingefügt -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            
            <!-- RECHTER BEREICH: Dashboard (1/3) -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Gesamtergebnis Karte -->
                <div class="bg-white p-6 rounded-xl shadow-xl border-l-8 border-teal-600">
                    <h2 class="text-2xl font-bold text-gray-700 mb-2">Gesamtergebnis</h2>
                    <div class="text-sm font-medium text-gray-500">Aktuelles Volumen der Liste:</div>
                    <div id="total-cubic-meters" class="text-5xl font-extrabold text-teal-800 mt-2">0.00 FM</div>
                    <div id="total-price" class="text-xl font-semibold text-gray-700 mt-4">Gesamtwert: <span class="font-extrabold text-green-700">€ 0.00</span></div>
                </div>

                <!-- Schnelle Aktionen -->
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Export & Verwaltung</h2>
                    <div class="space-y-3">
                        <button id="export-pdf-button" class="w-full flex items-center justify-center p-3 bg-teal-600 rounded-lg text-white font-bold hover:bg-teal-700 transition duration-200 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1l4 4 4-4m-4 4V7" />
                            </svg>
                            PDF-Lieferschein erstellen
                        </button>
                        <a href="kunden.html" class="w-full flex items-center justify-center p-3 bg-blue-600 rounded-lg text-white font-bold hover:bg-blue-700 transition duration-200 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-5m0 0l-4-4m4 4V7a2 2 0 00-2-2h-5" />
                            </svg>
                            Zur Kundenverwaltung
                        </a>
                        <button id="save-to-archive-button" class="w-full flex items-center justify-center p-3 bg-gray-200 rounded-lg text-gray-700 font-bold hover:bg-gray-300 transition duration-200 shadow-md">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                            </svg>
                            Archivieren (Liste leeren)
                        </button>
                    </div>
                </div>

                <!-- Preisübersicht -->
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Preiskalkulation</h2>
                    <p class="text-sm text-gray-600 mb-3">Aktuelle Preise pro Festmeter (FM):</p>
                    <div id="price-list" class="space-y-2">
                        <!-- Preise werden hier dynamisch eingefügt -->
                    </div>
                    <div class="text-xs text-gray-500 mt-4 p-2 bg-gray-50 rounded-lg">
                        Hinweis: Die Preise basieren auf simulierten Werten im JavaScript-Code.
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <!-- Fußzeile -->
    <footer class="bg-gray-800 text-white p-4 mt-auto">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; <span id="year"></span> Sägewerk Mülleder. Alle Rechte vorbehalten.</p>
        </div>
    </footer>

    <!-- MODAL für Löschbestätigung -->
    <div id="confirm-modal" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all duration-300 scale-100">
            <h3 class="text-xl font-bold text-red-600 mb-4">Achtung! Liste löschen</h3>
            <p class="text-gray-700 mb-6">Sind Sie sicher, dass Sie alle <span id="modal-count">X</span> erfassten Stämme unwiderruflich aus der Liste entfernen möchten?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 font-medium">Abbrechen</button>
                <button id="modal-confirm" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 font-bold">Liste löschen</button>
            </div>
        </div>
    </div>


    <!-- JavaScript für die Anwendungslogik -->
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- KONSTANTEN UND DATENVERWALTUNG ---

        // Simulierter Preis pro Festmeter (FM) basierend auf Baumart/Güte
        const PRICE_LIST = {
            'Fichte A': 125.00,
            'Fichte B': 95.00,
            'Tanne': 85.00,
            'Kiefer': 70.00,
            'Lärche': 110.00,
            'Eiche': 150.00,
            'Buche': 90.00,
            'Sonstige': 60.00
        };

        // Hilfsfunktion zum Laden von Kundendaten (identisch zu kunden.html)
        const initialCustomerData = [
            { id: 1, name: "Holzbau Schmidt GmbH", kontaktperson: "Max Schmidt", strasse: "Hauptstraße 10", plz: "8010", ort: "Graz", telefon: "0316 12345", email: "max@holzbau.at", status: "Aktiv" },
            { id: 2, name: "Forstbetrieb Maier", kontaktperson: "Elke Maier", strasse: "Waldweg 5", plz: "8700", ort: "Leoben", telefon: "03842 67890", email: "e.maier@forst.at", status: "Neu" },
            { id: 3, name: "Tischlerei Huber", kontaktperson: "Johannes Huber", strasse: "Industriepark 22", plz: "9020", ort: "Klagenfurt", telefon: "0463 98765", email: "j.huber@tischlerei.at", status: "In Bearbeitung" },
            { id: 4, name: "Privatkunde Bauer", kontaktperson: "Karl Bauer", strasse: "Wiesenweg 3", plz: "8042", ort: "Wetzelsdorf", telefon: "0664 1122334", email: "karl.bauer@gmx.at", status: "Inaktiv" },
        ];
        
        function loadCustomers() {
            let customers = localStorage.getItem('customers');
            if (customers) {
                return JSON.parse(customers).map(c => ({ ...c, id: parseInt(c.id) }));
            }
            return initialCustomerData.map((item, index) => ({ ...item, id: index + 1 })); // Einfache ID-Zuweisung für Initialdaten
        }

        // Die Liste, in der die erfassten Holzstämme gespeichert werden (wird aus localStorage geladen)
        let woodEntries = [];

        function loadEntries() {
            const data = localStorage.getItem('woodEntries');
            if (data) {
                // Konvertiert die IDs und numerischen Felder zurück in Zahlen
                woodEntries = JSON.parse(data).map(entry => ({
                    ...entry,
                    id: parseInt(entry.id),
                    laenge: parseFloat(entry.laenge),
                    durchmesser: parseInt(entry.durchmesser),
                    festmeter: parseFloat(entry.festmeter),
                    preis: parseFloat(entry.preis)
                }));
            } else {
                woodEntries = [];
            }
        }

        function saveEntries() {
            localStorage.setItem('woodEntries', JSON.stringify(woodEntries));
        }

        // --- HILFSFUNKTIONEN ---
        
        // Formatiert eine Zahl als Währung
        function formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        /**
         * Berechnet den Festmeter (FM) nach der zylindrischen Formel (vereinfacht für den Rechner).
         * Formel: (Durchmesser in cm / 100)^2 * Pi / 4 * Länge in m
         * Vereinfacht: (Durchmesser^2 * Länge * Pi) / 40000
         * Durchmesser wird in Meter umgerechnet (cm -> m).
         * @param {number} durchmesser - Durchmesser in cm
         * @param {number} laenge - Länge in Meter
         * @returns {number} Festmeter (FM)
         */
        function calculateFestmeter(durchmesser, laenge) {
            // Nur gültige Zahlen verwenden
            if (isNaN(durchmesser) || isNaN(laenge) || durchmesser <= 0 || laenge <= 0) {
                return 0;
            }
            // Durchmesser in Dezimeter (dm) umrechnen: d/10. FM = (d/10)^2 * PI/4 * L
            // Hier verwenden wir d in cm -> m (d/100)
            const dInMeters = durchmesser / 100;
            const festmeter = Math.pow(dInMeters, 2) * Math.PI / 4 * laenge;
            // Auf 4 Nachkommastellen runden
            return Math.round(festmeter * 10000) / 10000;
        }
        
        /**
         * Gibt die passenden Tailwind-Klassen für den Kundenstatus zurück.
         * @param {string} status - Der Status (z.B. "Aktiv", "Neu")
         * @returns {string} Tailwind-Klassen für den Badge
         */
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'Aktiv':
                    return 'status-badge aktiv';
                case 'Neu':
                    return 'status-badge neu';
                case 'In Bearbeitung':
                    return 'status-badge in_bearbeitung';
                case 'Inaktiv':
                default:
                    return 'status-badge inaktiv';
            }
        }

        // --- RENDERING-FUNKTIONEN ---

        /**
         * Füllt das Kunden-Dropdown beim Initialisieren.
         */
        function populateCustomerDropdown() {
            const customerSelect = document.getElementById('kunde');
            const customers = loadCustomers(); 
            
            // Bestehende Optionen entfernen (außer der ersten Placeholder-Option)
            while (customerSelect.options.length > 1) {
                customerSelect.remove(1);
            }

            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id; // Speichert die ID des Kunden
                option.textContent = customer.name;
                customerSelect.appendChild(option);
            });
        }
        
        /**
         * Aktualisiert das Status-Badge basierend auf dem ausgewählten Kunden.
         */
        function updateCustomerStatusDisplay() {
            const customerSelect = document.getElementById('kunde');
            const badgeContainer = document.getElementById('customer-status-badge');
            const selectedCustomerId = customerSelect.value;
            
            // Wenn kein Kunde ausgewählt ist, Badge leeren
            if (!selectedCustomerId || selectedCustomerId === "") {
                badgeContainer.innerHTML = '';
                return;
            }
            
            const customers = loadCustomers();
            const selectedCustomer = customers.find(c => c.id === parseInt(selectedCustomerId));

            if (selectedCustomer) {
                const status = selectedCustomer.status;
                const statusClass = getStatusBadgeClass(status);
                badgeContainer.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-xs font-bold text-gray-700">Status:</span>
                        <span class="${statusClass}">
                            ${status}
                        </span>
                    </div>
                `;
            } else {
                badgeContainer.innerHTML = '';
            }
        }


        /**
         * Rendert die Liste der erfassten Stämme in der Tabelle.
         */
        function renderTable() {
            const tbody = document.getElementById('wood-table-body');
            tbody.innerHTML = '';
            
            const totalStammeElement = document.getElementById('total-stamme');
            totalStammeElement.textContent = woodEntries.length;

            if (woodEntries.length === 0) {
                 const row = tbody.insertRow();
                 row.innerHTML = `<td colspan="7" class="px-3 py-4 text-center text-xs text-gray-500 italic bg-white">Noch keine Stämme erfasst.</td>`;
                 updateTotals(); // Aktualisiert die Gesamtwerte auch bei leerer Liste
                 return;
            }

            woodEntries.forEach((entry, index) => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-teal-50 transition duration-100';

                // 1. Laufende Nummer
                row.insertCell().textContent = index + 1;
                
                // 2. Baumart/Güte
                row.insertCell().textContent = entry.baumart;
                
                // 3. Länge (m)
                const laengeCell = row.insertCell();
                laengeCell.className = 'text-right';
                laengeCell.textContent = entry.laenge.toFixed(2);
                
                // 4. Durchmesser (cm)
                const durchmesserCell = row.insertCell();
                durchmesserCell.className = 'text-right';
                durchmesserCell.textContent = entry.durchmesser;
                
                // 5. Festmeter (FM)
                const fmCell = row.insertCell();
                fmCell.className = 'text-right font-bold text-teal-700';
                fmCell.textContent = entry.festmeter.toFixed(4);
                
                // 6. Notizen
                row.insertCell().textContent = entry.notizen;

                // 7. Aktionen
                const actionsCell = row.insertCell();
                actionsCell.className = 'text-right whitespace-nowrap space-x-2';
                actionsCell.innerHTML = `
                    <button onclick="window.editEntry(${entry.id})" class="text-blue-600 hover:text-blue-800 text-xs font-semibold transition duration-150 transform hover:scale-105">Bearbeiten</button>
                    <button onclick="window.deleteEntry(${entry.id})" class="text-red-600 hover:text-red-800 text-xs font-semibold transition duration-150 transform hover:scale-105">Löschen</button>
                `;
            });
            
            // Aktualisiert die Gesamtwerte
            updateTotals();
        }

        /**
         * Aktualisiert die Gesamt-Festmeter und den Gesamtpreis in der Dashboard-Karte.
         */
        function updateTotals() {
            const totalFestmeter = woodEntries.reduce((sum, entry) => sum + entry.festmeter, 0);
            const totalPrice = woodEntries.reduce((sum, entry) => sum + entry.preis, 0);

            document.getElementById('total-cubic-meters').textContent = `${totalFestmeter.toFixed(2)} FM`;
            document.getElementById('total-price').querySelector('span').textContent = formatCurrency(totalPrice);
        }
        
        /**
         * Aktualisiert die Preisübersicht im rechten Dashboard-Panel.
         */
        function updatePriceDisplay() {
            const priceListDiv = document.getElementById('price-list');
            priceListDiv.innerHTML = '';
            
            for (const [baumart, preis] of Object.entries(PRICE_LIST)) {
                const item = document.createElement('div');
                item.className = 'flex justify-between text-sm text-gray-800';
                item.innerHTML = `
                    <span class="font-medium">${baumart}:</span>
                    <span class="font-semibold text-green-700">${formatCurrency(preis)} / FM</span>
                `;
                priceListDiv.appendChild(item);
            }
        }


        // --- CRUD-AKTIONEN ---

        /**
         * Setzt das Formular zurück und bereitet es für eine neue Eingabe vor.
         */
        function resetFormForNewEntry() {
            const form = document.getElementById('wood-entry-form');
            const submitButton = document.getElementById('submit-button');
            const editingIdInput = document.getElementById('editing-id');
            const kundeSelect = document.getElementById('kunde');
            
            // Formular-Zustand für neue Eingabe vorbereiten
            submitButton.textContent = 'Hinzufügen';
            submitButton.classList.replace('bg-blue-600', 'bg-green-600');
            submitButton.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
            editingIdInput.value = '';

            // Alle Felder leeren, außer dem Kunden, Baumart und Länge (für schnelle sequentielle Eingabe)
            const originalKunde = kundeSelect.value;
            const originalBaumart = document.getElementById('baumart').value;
            const originalLaenge = document.getElementById('laenge').value;
            
            form.reset();

            // Werte wiederherstellen
            kundeSelect.value = originalKunde;
            document.getElementById('baumart').value = originalBaumart;
            document.getElementById('laenge').value = originalLaenge;
            updateCustomerStatusDisplay(); // Stellt sicher, dass das Badge aktuell ist
        }

        /**
         * Bearbeitet einen ausgewählten Stamm.
         */
        window.editEntry = function(id) {
            const entryToEdit = woodEntries.find(e => e.id === id);
            if (entryToEdit) {
                // Formularfelder füllen
                document.getElementById('kunde').value = entryToEdit.kundeId;
                document.getElementById('baumart').value = entryToEdit.baumart;
                document.getElementById('laenge').value = entryToEdit.laenge;
                document.getElementById('durchmesser').value = entryToEdit.durchmesser;
                document.getElementById('notizen').value = entryToEdit.notizen;

                // Versteckte ID setzen
                document.getElementById('editing-id').value = id;

                // Button-Text und Farbe ändern
                const submitButton = document.getElementById('submit-button');
                submitButton.textContent = 'Speichern & Korrigieren';
                submitButton.classList.replace('bg-green-600', 'bg-blue-600');
                submitButton.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                
                // Status-Badge aktualisieren
                updateCustomerStatusDisplay();
                
                document.getElementById('kunde').focus();
            }
        }

        /**
         * Löscht einen Stamm.
         */
        window.deleteEntry = function(id) {
            const originalLength = woodEntries.length;
            woodEntries = woodEntries.filter(e => e.id !== id);
            
            if (woodEntries.length < originalLength) {
                saveEntries();
                renderTable();
                
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Stamm erfolgreich entfernt.';
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 3000);
            }
        }

        // --- PDF EXPORT LOGIK ---

        function exportToPDF() {
            if (woodEntries.length === 0) {
                alert('Die Liste ist leer. Bitte erfassen Sie zuerst Stämme.');
                return;
            }

            // Sicherstellen, dass die jsPDF-Bibliothek verfügbar ist
            if (typeof window.jsPDF === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.autoTable === 'undefined') {
                 // Fallback für die jsPDF-Versionierung (wird normalerweise von den Skript-Tags geladen)
                 const jsPDF = window.jsPDF.jsPDF || window.jspdf.jsPDF;
                 if (typeof jsPDF === 'undefined') {
                    alert('PDF-Bibliothek nicht geladen. Bitte versuchen Sie es erneut.');
                    return;
                 }
            }
            
            const { jsPDF } = window.jspdf; // Korrekte Initialisierung
            const doc = new jsPDF('p', 'mm', 'a4');
            const customers = loadCustomers();
            const selectedCustomerId = document.getElementById('kunde').value;
            const customer = customers.find(c => c.id === parseInt(selectedCustomerId)) || { name: "Unbekannter Kunde", strasse: "N/A", plz: "N/A", ort: "N/A" };

            let y = 10;
            const margin = 15;
            const lineHeight = 7;
            const cellHeight = 10;
            const tableStartY = 50; 
            
            // 1. Titel
            doc.setFontSize(18);
            doc.setTextColor(30, 144, 255); // Deep Sky Blue
            doc.text("Lieferschein / Holzliste", margin, y);
            y += lineHeight;

            // 2. Kundeninformationen
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50); // Dunkelgrau
            doc.text("Sägewerk Mülleder", margin, y);
            doc.text("Datum: " + new Date().toLocaleDateString('de-DE'), 195, y, { align: "right" });
            y += lineHeight;
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text("Lieferung an:", margin, y);
            y += lineHeight;
            
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            doc.text(`Kunde: ${customer.name}`, margin, y); y += lineHeight - 2;
            doc.text(`Adresse: ${customer.strasse}, ${customer.plz} ${customer.ort}`, margin, y); y += lineHeight + 2;

            // 3. Tabellenkopf und Daten vorbereiten
            const headers = [
                ['Lauf. Nr.', 'Baumart/Güte', 'Länge (m)', 'Durchmesser (cm)', 'Festmeter (FM)', 'Einzelpreis (€/FM)', 'Gesamtpreis (€)', 'Notizen']
            ];
            
            const data = woodEntries.map((entry, index) => [
                index + 1,
                entry.baumart,
                entry.laenge.toFixed(2),
                entry.durchmesser,
                entry.festmeter.toFixed(4),
                formatCurrency(PRICE_LIST[entry.baumart] || 0),
                formatCurrency(entry.preis),
                entry.notizen
            ]);
            
            const totalFestmeter = woodEntries.reduce((sum, entry) => sum + entry.festmeter, 0);
            const totalPrice = woodEntries.reduce((sum, entry) => sum + entry.preis, 0);

            // 4. PDF AutoTable Generation
            doc.autoTable({
                head: headers,
                body: data,
                startY: tableStartY,
                theme: 'striped',
                headStyles: { 
                    fillColor: [6, 182, 212], // Teal-500
                    textColor: 255, 
                    fontSize: 8, 
                    halign: 'center' 
                },
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                columnStyles: {
                    0: { cellWidth: 10, halign: 'right' }, // Lauf. Nr.
                    2: { halign: 'right' }, // Länge
                    3: { halign: 'right' }, // Durchmesser
                    4: { halign: 'right', fontStyle: 'bold' }, // FM
                    5: { halign: 'right' }, // Einzelpreis
                    6: { halign: 'right', fontStyle: 'bold' }, // Gesamtpreis
                    7: { cellWidth: 35 } // Notizen
                },
                didDrawPage: function(data) {
                    // Fußzeile auf jeder Seite
                    doc.setFontSize(8);
                    doc.text("Seite " + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 5);
                }
            });

            // 5. Fußzeile / Zusammenfassung
            const finalY = doc.autoTable.previous.finalY + 10;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            doc.text("ZUSAMMENFASSUNG DER LIEFERUNG", margin, finalY);
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            
            let summaryY = finalY + lineHeight;
            doc.text(`Gesamtzahl Stämme: ${woodEntries.length}`, margin, summaryY); 
            summaryY += lineHeight;
            doc.setFontSize(14);
            doc.setTextColor(6, 182, 212); // Teal-500
            doc.text(`Gesamtes Volumen: ${totalFestmeter.toFixed(2)} FM`, margin, summaryY);
            doc.setTextColor(34, 139, 34); // Forest Green
            doc.text(`Gesamtwert: ${formatCurrency(totalPrice)}`, 195, summaryY, { align: "right" });
            
            // 6. Speichern
            const filename = `Holzliste_${customer.name.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(filename);
        }

        // --- EVENT HANDLER ---

        // 1. Initialisierung beim Laden der Seite
        document.addEventListener('DOMContentLoaded', () => {
            loadEntries(); // Lädt die gespeicherte Liste
            populateCustomerDropdown(); // Lädt die Kunden in das Dropdown
            updateCustomerStatusDisplay(); // Zeigt den Status an (falls ein Kunde voreingestellt ist)
            renderTable(); // Rendert die Tabelle
            updatePriceDisplay(); // Zeigt die Preisliste an
            
            // Setzt den Fokus auf das erste Eingabefeld (Kunde)
            document.getElementById('kunde').focus(); 
        });
        
        // 2. Event-Listener für Kunden-Dropdown
        document.getElementById('kunde').addEventListener('change', updateCustomerStatusDisplay);

        // 3. Event-Listener für den PDF-Export
        document.getElementById('export-pdf-button').addEventListener('click', exportToPDF);
        
        // 4. Event-Listener für "Liste leeren" (öffnet Modal)
        document.getElementById('clear-list-button').addEventListener('click', () => {
            if (woodEntries.length === 0) {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Die Liste ist bereits leer!';
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-yellow-600 font-semibold';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 3000);
                return;
            }
            document.getElementById('modal-count').textContent = woodEntries.length;
            document.getElementById('confirm-modal').classList.remove('hidden');
        });

        // 5. Modal-Abbrechen
        document.getElementById('modal-cancel').addEventListener('click', () => {
            document.getElementById('confirm-modal').classList.add('hidden');
        });

        // 6. Modal-Bestätigen (Liste wirklich löschen)
        document.getElementById('modal-confirm').addEventListener('click', () => {
            woodEntries = []; // Leert die Liste
            saveEntries(); // Speichert den leeren Stand
            renderTable(); // Aktualisiert die Tabelle
            resetFormForNewEntry(); // Setzt das Formular zurück
            
            document.getElementById('confirm-modal').classList.add('hidden');
            
            const feedback = document.getElementById('feedback-message');
            feedback.textContent = 'Liste erfolgreich gelöscht und auf Null zurückgesetzt!';
            feedback.className = 'col-span-2 md:col-span-7 text-sm text-green-600 font-semibold';
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 4000);
        });
        
        // 7. Event-Listener für den Archivieren-Button (aktuelle Liste löschen, aber Kunden beibehalten)
        document.getElementById('save-to-archive-button').addEventListener('click', () => {
            // Hinweis: Da keine Archiv-Datenbank/Struktur existiert, simulieren wir nur das "Archivieren" 
            // durch das Löschen der aktuellen Liste (wie beim "Liste leeren"-Button).
            // In einer echten App würde man die Liste hier in eine "Archiv-Collection" in Firestore verschieben.
            if (woodEntries.length === 0) {
                const feedback = document.getElementById('feedback-message');
                feedback.textContent = 'Die Liste ist leer. Es gibt nichts zu archivieren!';
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-yellow-600 font-semibold';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 3000);
                return;
            }

            // Alternativ könnte man hier direkt den PDF-Export triggern und danach löschen:
            exportToPDF();

            woodEntries = []; // Leert die Liste
            saveEntries(); // Speichert den leeren Stand
            renderTable(); // Aktualisiert die Tabelle
            resetFormForNewEntry(); // Setzt das Formular zurück
            
            const feedback = document.getElementById('feedback-message');
            feedback.textContent = 'Liste wurde archiviert (PDF erstellt) und zurückgesetzt!';
            feedback.className = 'col-span-2 md:col-span-7 text-sm text-green-600 font-semibold';
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 5000);
        });


        // 8. Formular-Submit-Handler (Hinzufügen & Bearbeiten)
        document.getElementById('wood-entry-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const form = e.target;
            const kundeSelect = document.getElementById('kunde');
            const laengeInput = document.getElementById('laenge');
            const durchmesserInput = document.getElementById('durchmesser');
            const editingIdInput = document.getElementById('editing-id');
            const feedback = document.getElementById('feedback-message');
            
            const isEditing = !!editingIdInput.value; 

            // Validierung, dass ein Kunde ausgewählt ist
            if (!kundeSelect.value) {
                feedback.textContent = 'Bitte wählen Sie zuerst einen Kunden aus!';
                feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 3000);
                return;
            }
            
            const laenge = parseFloat(laengeInput.value);
            const durchmesser = parseInt(durchmesserInput.value);
            const baumart = form.baumart.value;
            const festmeter = calculateFestmeter(durchmesser, laenge);
            const preisProFM = PRICE_LIST[baumart] || 0;
            const gesamtPreis = festmeter * preisProFM;

            // Speichert die Original-Länge, falls wir für die nächste Eingabe nur den Durchmesser ändern wollen
            const originalLaenge = laengeInput.value; 


            const newEntry = {
                kundeId: parseInt(kundeSelect.value), // Kunden-ID speichern
                baumart: baumart,
                laenge: laenge,
                durchmesser: durchmesser,
                notizen: form.notizen.value,
                festmeter: festmeter,
                preis: gesamtPreis
            };


            if (isEditing) {
                // Bearbeitung
                const id = parseInt(editingIdInput.value);
                const index = woodEntries.findIndex(e => e.id === id);
                
                if (index !== -1) {
                    woodEntries[index] = { ...newEntry, id: id };
                    feedback.textContent = 'Eintrag erfolgreich korrigiert!';
                    
                    // Logik: Da es sich um einen einzelnen Korrekturvorgang handelt
                    resetFormForNewEntry(); 
                    
                    // Setzt den Fokus nach der Bearbeitung auf das Kundenfeld, um die Eingabesequenz neu zu starten
                    document.getElementById('kunde').focus();
                } else {
                    // Sollte nicht passieren
                    feedback.textContent = 'Fehler: Eintrag zum Bearbeiten nicht gefunden.';
                    feedback.className = 'col-span-2 md:col-span-7 text-sm text-red-600 font-semibold';
                    feedback.classList.remove('hidden');
                    return; // Beendet die Funktion
                }
            } else {
                // Neuer Eintrag
                newEntry.id = Date.now(); 
                woodEntries.push(newEntry);
                feedback.textContent = 'Eintrag erfolgreich gespeichert und zur Tabelle hinzugefügt!';
                
                // Logik: Länge beibehalten und Durchmesser zurücksetzen
                durchmesserInput.value = ''; // Durchmesser löschen
                laengeInput.value = originalLaenge; // Länge beibehalten
                durchmesserInput.focus(); // Fokus auf Durchmesser setzen
            }


            // Speichern, Tabelle neu rendern
            saveEntries();
            renderTable();
            updatePriceDisplay(); // Preis-Anzeige für nächste Eingabe aktualisieren

            // Feedback anzeigen
            feedback.className = 'col-span-2 md:col-span-7 text-sm text-green-600 font-semibold';
            feedback.classList.remove('hidden');
            
            // Feedback nach 3 Sekunden ausblenden
            setTimeout(() => feedback.classList.add('hidden'), 3000);
        });
    </script>
</body>
</html>
