<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holzrechner Archiv Übersicht</title>
    <!-- Einbindung von Tailwind CSS für Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .table-font {
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

     <!-- SICHERHEIT: ANMELDEBILDSCHIRM (Muss auf jeder geschützten Seite vorhanden sein) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 bg-gray-50 fixed inset-0 z-50 hidden opacity-0">
        <div class="w-full max-w-md bg-white p-8 shadow-2xl rounded-xl border border-gray-100 transition-opacity duration-500 ease-in-out">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Zugriff erforderlich</h1>
            <p id="error-message" class="text-red-600 font-medium mb-4 text-center hidden">Falscher Benutzername oder falsches Passwort.</p>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Benutzername (admin)</label>
                    <input type="text" id="username" name="username" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150"
                           placeholder="Benutzername eingeben">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Passwort (admin)</label>
                    <input type="password" id="password" name="password" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150"
                           placeholder="Passwort eingeben">
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-lg hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                    Anmelden
                </button>
            </form>
        </div>
    </div>
    <!-- ENDE: SICHERHEIT: ANMELDEBILDSCHIRM -->

    <!-- Navigationsleiste -->
    <nav class="bg-white shadow-xl p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center max-w-7xl">
            <!-- Logo oder Markenname -->
            <a href="index.html" class="text-2xl font-extrabold text-blue-600">Sägewerk Mülleder</a>
            <!-- Navigationslinks mit ARCHIV -->
            <div class="flex space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Dashboard</a>
                <a href="archiv.html" class="text-blue-600 font-bold hover:text-blue-800 transition duration-300 border-b-3 border-blue-600 pb-1">Archiv</a>
                <a href="kunden.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Kunden</a>
                <a href="preise.html" class="text-gray-600 hover:text-blue-600 font-medium transition duration-300">Preise</a>
            </div>
        </div>
    </nav>

    <!-- Hauptinhalt (Archiv Ansicht) -->
    <main class="flex-grow container mx-auto p-4 sm:p-8 max-w-7xl">
        <div class="w-full mx-auto">
            <!-- HAUPTTITEL FÜR DIE SEITE -->
            <h1 class="text-4xl font-extrabold text-green-700 mb-2 text-center sm:text-left">
                Gutschrifts-Archiv
            </h1>
            <p class="text-gray-600 mb-8 text-center sm:text-left">
                Hier finden Sie alle archivierten Gutschrifts-Sitzungen.
            </p>

            <!-- Archiv Container -->
            <div id="archive-list" class="space-y-6">
                <!-- Archiv-Einträge werden hier dynamisch eingefügt -->
            </div>
            
            <!-- Wenn Archiv leer ist -->
            <div id="empty-archive-message" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg shadow-inner mt-10">
                <p class="text-sm font-medium text-yellow-800">
                    <svg class="inline-block w-5 h-5 mr-2 -mt-0.5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h.01a1 1 0 100-2H10V9a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    Das Archiv ist leer. Archivieren Sie Gutschriften im Dashboard, um sie hier anzuzeigen.
                </p>
            </div>

            <!-- Button zum Löschen des gesamten Archivs -->
            <div class="mt-10 pt-6 border-t border-gray-200 flex justify-end">
                <button id="clear-all-button" onclick="window.confirmClearAll()" class="px-6 py-2 text-base font-semibold text-white bg-red-600 rounded-xl hover:bg-red-700 transition duration-300 shadow-lg disabled:opacity-50" disabled>
                    Gesamtes Archiv endgültig löschen
                </button>
            </div>

        </div>
    </main>

    <!-- Fußzeile -->
    <footer class="bg-gray-800 text-white p-6 mt-auto">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; <span id="year"></span> Sägewerk Mülleder. Alle Rechte vorbehalten.</p>
        </div>
    </footer>
    
    <!-- Benutzerdefiniertes Bestätigungs-Modal (ersetzt prompt/confirm) -->
    <div id="confirmation-modal" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all duration-300 scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">Aktion bestätigen</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Sind Sie sicher, dass Sie diesen Vorgang durchführen möchten?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.hideConfirmation(false)" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Abbrechen
                </button>
                <button id="modal-confirm-button" onclick="window.hideConfirmation(true)" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">
                    Bestätigen
                </button>
            </div>
        </div>
    </div>


    <!-- JavaScript für die Archiv-Logik -->
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
        let actionOnConfirm = null; 
        let actionParam = null;

        /**
         * Zeigt das Bestätigungs-Modal an.
         */
        window.showConfirmation = function(title, message, onConfirmAction, param = null, confirmText = 'Bestätigen') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-button').textContent = confirmText;
            
            const confirmButton = document.getElementById('modal-confirm-button');
            confirmButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-blue-600', 'hover:bg-blue-700');

            if (confirmText.includes('Löschen') || confirmText.includes('endgültig')) {
                 confirmButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                 confirmButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }

            document.getElementById('confirmation-modal').classList.remove('hidden');
            actionOnConfirm = onConfirmAction;
            actionParam = param;
        }
        
        /**
         * Versteckt das Bestätigungs-Modal und führt die Aktion aus (falls bestätigt).
         */
        window.hideConfirmation = function(confirmed) {
            document.getElementById('confirmation-modal').classList.add('hidden');
            if (confirmed && actionOnConfirm) {
                actionOnConfirm(actionParam);
            }
            actionOnConfirm = null;
            actionParam = null;
        }

        /**
         * Lädt die archivierten Gutschrifts-Sitzungen aus dem localStorage.
         */
        function loadArchivedEntries() {
            try {
                const data = localStorage.getItem('archivedEntries');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Fehler beim Laden der Archive:", e);
                return [];
            }
        }

        /**
         * Löscht alle Archive und rendert die Liste neu.
         */
        window.handleClearAll = function() {
            localStorage.removeItem('archivedEntries');
            renderArchiveList();
            
            // Optional: Feedback-Meldung anzeigen
            alert("Das gesamte Archiv wurde endgültig gelöscht.");
        }

        /**
         * Bestätigt das Löschen aller Archive.
         */
        window.confirmClearAll = function() {
            window.showConfirmation(
                'Gesamtes Archiv löschen', 
                'Sind Sie sicher, dass Sie alle archivierten Gutschriften endgültig löschen möchten? Diese Aktion kann NICHT rückgängig gemacht werden!', 
                window.handleClearAll, 
                null,
                'Ja, endgültig löschen'
            );
        }

        /**
         * Rendert die Liste der Archiv-Sitzungen.
         */
        function renderArchiveList() {
            const archiveListContainer = document.getElementById('archive-list');
            const archivedEntries = loadArchivedEntries();
            const clearAllButton = document.getElementById('clear-all-button');
            const emptyMessage = document.getElementById('empty-archive-message');

            archiveListContainer.innerHTML = '';

            if (archivedEntries.length === 0) {
                clearAllButton.disabled = true;
                emptyMessage.classList.remove('hidden');
                return;
            }
            
            clearAllButton.disabled = false;
            emptyMessage.classList.add('hidden');

            archivedEntries.forEach(session => {
                // Finde den ersten Kunden (alle Logs in einer Session sind normalerweise für denselben Kunden)
                const firstCustomer = session.entries.length > 0 ? session.entries[0].kunde : 'N/A';
                
                // Erstelle das Haupt-Card-Element
                const card = document.createElement('div');
                card.id = `session-${session.id}`;
                card.className = 'bg-white shadow-xl rounded-xl p-6 border-t-4 border-blue-500';

                // Basis-Informationen
                card.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-4">
                        <h2 class="text-xl font-bold text-blue-700">Archiv #${session.id}</h2>
                        <span class="text-sm text-gray-500 mt-1 sm:mt-0">Archiviert am: ${session.timestamp}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                        <!-- Kunde -->
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-gray-500 font-medium">Kunde:</p>
                            <p class="font-semibold text-gray-800 truncate">${firstCustomer}</p>
                        </div>
                        <!-- Stämme -->
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-gray-500 font-medium">Stämme:</p>
                            <p class="font-semibold text-gray-800">${session.count}</p>
                        </div>
                        <!-- Gesamtvolumen -->
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-gray-500 font-medium">Gesamt-Volumen:</p>
                            <p class="font-bold text-blue-800">${session.totalVolume} fm</p>
                        </div>
                        <!-- Gesamtpreis Brutto -->
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-gray-500 font-medium">Gesamt-Brutto:</p>
                            <p class="font-bold text-green-800">${session.totalBruttoPrice} €</p>
                        </div>
                    </div>

                    <!-- Detail-Bereich (wird per JS befüllt) -->
                    <div id="details-${session.id}" class="details-section hidden mt-6 pt-4 border-t border-gray-200">
                        <!-- Tabelle wird hier eingefügt -->
                    </div>

                    <!-- Aktionen -->
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.toggleDetails(${session.id})" class="toggle-button px-4 py-2 text-sm font-semibold text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 transition duration-300">
                            Details anzeigen
                        </button>
                    </div>
                `;
                
                archiveListContainer.appendChild(card);
            });
        }
        
        /**
         * Zeigt oder versteckt die detaillierte Tabelle für eine Archiv-Sitzung.
         */
        window.toggleDetails = function(sessionId) {
            const detailsElement = document.getElementById(`details-${sessionId}`);
            const toggleButton = detailsElement.closest('.bg-white').querySelector('.toggle-button');
            
            if (detailsElement.classList.contains('hidden')) {
                // Anzeigen
                const archivedEntries = loadArchivedEntries();
                const session = archivedEntries.find(s => s.id === sessionId);
                
                if (session) {
                    detailsElement.innerHTML = generateDetailTableHTML(session.entries);
                    detailsElement.classList.remove('hidden');
                    toggleButton.textContent = 'Details ausblenden';
                }
            } else {
                // Ausblenden
                detailsElement.classList.add('hidden');
                toggleButton.textContent = 'Details anzeigen';
            }
        }

        /**
         * Erstellt den HTML-Code für die detaillierte Stamm-Tabelle.
         */
        function generateDetailTableHTML(entries) {
            let tableRows = entries.map((entry, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 text-left text-xs font-medium text-gray-900">${index + 1}</td>
                    <td class="px-3 py-2 text-left text-xs text-gray-600">${entry.holzart}</td>
                    <td class="px-3 py-2 text-left text-xs text-gray-600">${entry.qualitaet}</td>
                    <td class="px-3 py-2 text-right text-xs text-gray-600">${entry.laenge.toFixed(2)} m</td>
                    <td class="px-3 py-2 text-right text-xs text-gray-600">${entry.durchmesser.toFixed(1)} cm</td>
                    <td class="px-3 py-2 text-center text-xs font-semibold text-blue-700">${entry.classification}</td>
                    <td class="px-3 py-2 text-right text-xs font-bold text-blue-800 bg-blue-50">${entry.festmeter.toFixed(3)} fm</td>
                    <td class="px-3 py-2 text-right text-xs text-green-700">${entry.bruttoPrice.toFixed(2)} €</td>
                </tr>
            `).join('');

            return `
                <h3 class="text-lg font-bold text-gray-700 mb-3">Detaillierte Stämme dieser Gutschrift:</h3>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-inner">
                    <table class="min-w-full divide-y divide-gray-200 table-font">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase">Nr.</th>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase">Holzart</th>
                                <th class="px-3 py-2 text-left text-xs font-bold text-gray-600 uppercase">Qualität</th>
                                <th class="px-3 py-2 text-right text-xs font-bold text-gray-600 uppercase">Länge</th>
                                <th class="px-3 py-2 text-right text-xs font-bold text-gray-600 uppercase">Ø</th>
                                <th class="px-3 py-2 text-center text-xs font-bold text-gray-600 uppercase">Klass.</th>
                                <th class="px-3 py-2 text-right text-xs font-bold text-gray-600 uppercase">Festmeter</th>
                                <th class="px-3 py-2 text-right text-xs font-bold text-gray-600 uppercase">Brutto</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }


        // Initiales Rendern der Liste beim Laden der Seite
        document.addEventListener('DOMContentLoaded', renderArchiveList);
    </script>
</body>
</html>
